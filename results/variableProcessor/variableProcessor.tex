\documentclass[twocolumn]{article}[10pt]
\usepackage[left=1in, right=1in, top=1in, bottom=1in]{geometry}
\usepackage[moderate, mathspacing=normal]{savetrees}

\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{xspace}

\newcommand{\defn}[1]{{\textit{\textbf{\boldmath #1}}}\xspace}
\renewcommand{\paragraph}[1]{\vspace{0.09in}\noindent{\bf \boldmath #1.}} 
\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator{\Var}{\text{Var}}
\DeclareMathOperator{\img}{Im}
\DeclareMathOperator{\polylog}{\text{polylog}}
\DeclareMathOperator{\poly}{\text{poly}}
\DeclareMathOperator{\st}{\text{ such that }}
\DeclareMathOperator{\tilt}{\text{tilt}}
\DeclareMathOperator{\fil}{\text{fill}}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}

\newcommand{\contr}[0]{\[ \Rightarrow\!\Leftarrow \]}
\newcommand{\defeq}{\vcentcolon=}
\newcommand{\eqdef}{=\vcentcolon}

\newtheorem{fact}{Fact}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}
\newtheorem{proposition}{Proposition}
\newtheorem{clm}{Claim}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{theorem}{Theorem}
\newtheorem{conjecture}{Conjecture}

\usepackage{authblk}
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}
\fancyfoot{}
\fancyfoot[R]{\thepage}
\renewcommand{\headrulewidth}{0pt}

\title{Variable-Processor Cup Games}
\date{\vspace{-5ex}}

\author[1]{\small William Kuszmaul\thanks{Supported by a Hertz fellowship and a NSF GRFP fellowship}}
\author[2]{\small Alek Westover\thanks{Supported by MIT}}

\affil[ ]{\footnotesize MIT\textsuperscript{1}, MIT\textsuperscript{2}}
\affil[ ]{\textit{kuszmaul@mit.edu, alek.westover@gmail.com}}


\begin{document}
\maketitle
\abstract{ 
  In a \defn{cup game} two players, the \defn{filler} and the \defn{emptier},
  take turns adding and removing water from cups, subject to certain
  constraints. In the classic $p$-processor cup game the filler distributes
  $p$ units of water among the $n$ cups with at most $1$ unit of water to any
  particular cup, and the emptier chooses $p$ cups to remove at most one unit
  of water from. Analysis of the cup game is important for applications in
  processor scheduling, buffer management in networks, quality of service
  guarantees, and deamortization.

  We investigate a new variant of the classic $p$-processor cup game, which
  we call the \defn{variable-processor cup game}, in which the resources of the
  emptier and filler are variable. In particular, in the variable-processor cup
  game the filler is allowed to change $p$ at the beginning of each round. 
  Although the modification to allow variable resources seems small, we
  show that it drastically alters the game.

  We construct an adaptive filling strategy that achieves backlog
  $\Omega(n^{1-\epsilon})$ for any constant $\epsilon >0$ of our choice in
  running time $2^{O(\log^2 n)}$. This is enormous compared to the upper
  bound of $O(\log n)$ that holds in the classic $p$-processor cup game!
  We also present a simple adaptive filling strategy that is able to
  achieve backlog $\Omega(n)$ in extremely long games: it has running time
  $2^{O(n)}.$

  Furthermore, we demonstrate that this lower bound on backlog is tight: 
  using a novel set of invariants we prove that a greedy emptier never lets
  backlog exceed $O(n)$.

  We also construct an oblivious filling strategy that achieves backlog
  $\Omega(n^{1-\epsilon})$ for $\epsilon>0$ constant of our choice in time
  $2^{O(\log^2 n)}$ against any ``greedy-like" emptier with probability at least
  $1-2^{-\polylog(n)}$. Whereas classically randomization gives the emptier a
  large advantage, in the variable-processor cup game the lower bound is the same!
}
\thispagestyle{fancy}

\section{Introduction}\label{sec:intro}
\paragraph{Definition and Motivation}
The \defn{cup game} is a multi-round game in which the two players, the
\defn{filler} and the \defn{emptier}, take turns adding and removing water
from cups. On each round of the classic \defn{$p$-processor cup game} on $n$
cups, the filler first distributes $p$ units of water among
the $n$ cups with at most $1$ unit to any particular cup (without this
restriction the filler can trivially achieve unbounded backlog by placing all
of its fill in a single cup every round), and then the emptier 
removes at most $1$ unit of water from each of $p$ cups.\footnote{Note that negative
fill is not allowed, so if the emptier empties from a cup with fill below $1$
that cup's fill becomes $0$.} The game has been studied for \defn{adaptive}
fillers, i.e. fillers that can observe the emptier's actions, and for
\defn{oblivious} fillers, i.e. fillers that cannot observe the emptier's actions.

The cup game naturally arises in the study of processor-scheduling. The
incoming water added by the filler represents work added to the system at time
steps. At each time step after the new work comes in, each of $p$ processors
must be allocated to a task which they will achieve $1$ unit of progress on
before the next time step. The assignment of processors to tasks is modeled by
the emptier deciding which cups to empty from. The backlog of the system is the
largest amount of work left on any given task; in the cup game the
\defn{backlog} of the cups is the fill of the fullest cup at a given state. In
analyzing a cup game we aim to prove upper and lower bounds on backlog.

\paragraph{Previous Work}
The bounds on backlog are well known for the case where $p=1$, i.e. the
\defn{single-processor cup game}.
In the single-processor cup game an adaptive filler can achieve backlog
$\Omega(\log n)$ and a greedy emptier never lets backlog exceed $O(\log n)$. In
the randomized version of the single-processor cup game, i.e. when the filler
is oblivious, which can be interpreted as a smoothed analysis of the
deterministic version, the emptier never lets backlog exceed $O(\log \log n)$,
and a filler can achieve backlog $\Omega(\log\log n)$.

Recently Kuszmaul has established bounds on the case where $p>1$, i.e. the
\defn{multi-processor cup game} \cite{wku20}. Kuszmaul showed that a greedy
emptier never lets backlog exceed $O(\log n)$. He also proved a lower bound of
$\Omega(\log (n-p))$ on backlog. Recently we showed a lower bound of
$\Omega(\log n - \log (n-p))$. Combined, these lower bounds bounds imply a
lower bound of $\Omega(\log n)$. Kuszmaul also established an upper bound of
$O(\log\log n + \log p)$ against oblivious fillers, and a lower bound of
$\Omega(\log\log n)$. Tight bounds on backlog against an oblivious
filler are not yet known for large $p$.

\paragraph{Our Variant}
We investigate a new variant of the classic $p$-processor cup game which we call
the \defn{variable-processor cup game}. In the variable-processor cup game the
filler is allowed to change $p$ (the total amount of water that the filler
adds, and the emptier removes, from the cups per round) at the beginning of
each round. Note that we do not allow the resources of the filler and emptier
to vary separately; just like in the classic cup game we take the resources of
the filler and emptier to be identical.
This restriction is crucial; if
the filler has more resources than the emptier, then
the filler could trivially achieve unbounded backlog, as average fill will
increase by at least some positive constant at each round.
Taking the resources of the players to be identical makes the game balanced,
and hence interesting.

A priori having variable resources offers neither player a clear advantage:
lower values of $p$ mean that the emptier is at more of a discretization
disadvantage but also mean that the filler can ``anchor" fewer cups\footnote{A
useful part of many filling algorithms is maintaining an ``anchor" set of
``anchored" cups. The filler always places $1$ unit of water in each anchored
cup. This ensures that the fill of an anchored cup never decreases after it is
placed in the anchor set.}. Furthermore, at any fixed value of $p$ upper bounds
have been proven. For instance, regardless of $p$ a greedy emptier prevents an
adaptive filler from having backlog greater than $O(\log n)$. Switching between
different values of $p$, all of which the filler cannot individually use to get
backlog larger than $O(\log n)$ is not obviously going to help the filler achieve larger backlog.
We hoped that the variable-processor cup game could
be simulated in the classic multi-processor cup game, because the extra
ability given to the filler does not seem very strong. 

However, we show that attempts at simulating the variable-processor cup
game are futile because the variable-processor cup game
is vastly different from the classic multi-processor cup game. 

\paragraph{Outline and Results}
In Section \ref{sec:prelims} we establish the conventions and notations we will
use to discuss the variable-processor cup game. 

In Section \ref{sec:adaptive} we provide an inductive
proof of a lower bound on backlog with an adaptive filler. Theorem 
\ref{thm:adaptivePoly} states that a filler can achieve backlog
$\Omega(n^{1-\epsilon})$ for any constant $\epsilon > 0$ in quasi-polynomial
running time. Theorem \ref{thm:adaptivePoly} also provides an extremal strategy
that achieves backlog $\Omega(n)$ in incredibly long games: it has exponential
running time.

In Section \ref{sec:upperBound} we prove a novel invariant maintained
by the greedy emptier. In particular Theorem \ref{thm:invariant} establishes
that a greedy emptier keeps the average fill of the $k$ fullest cups at most
$2n-k$. In particular this implies (setting $k=1$) that a greedy emptier
prevents backlog from exceeding $O(n)$. 

The lower bound and upper bound agree; our analysis is tight for adaptive fillers!

In Section \ref{sec:oblivious} we prove a lower bound on backlog with an oblivious filler. 
Theorem \ref{thm:obliviousPoly} states that an oblivious filler can achieve
backlog $\Omega(n^{1-\epsilon})$ for any constant $\epsilon > 0$ in
quasi-polynomial time with probability at least $1-2^{-\polylog(n)}$.
Theorem \ref{thm:obliviousPoly} only applies to a certain class of emptiers:
``greedy-like emptiers". Nonetheless, this class of emptiers is very
interesting; it contains the emptiers that are used in upper bound proofs.
It is shocking that randomization doesn't help the emptier in this game;
usually the lower bound for backlog in the randomized version of a cup game is
$\log$ of the backlog in the deterministic setting!

\section{Preliminaries}\label{sec:prelims}
The cup game consists of a sequence of rounds. On the $t$-th round, the state
starts as $S_t$. The filler chooses the number of processors $p_t$ for the
round. Then the filler distributes $p_t$ units of water among the cups (with at
most $1$ unit of water to any particular cup). After this, the game is in an
intermediate state, which we call state $I_t$. Then the emptier chooses $p_t$
cups to empty at most $1$ unit of water from. Note that if the fill of a cup
that the emptier empties from is less than $1$ the emptier reduces the fill of
this cup to $0$ by emptying from it; we say that the emptier \defn{zeroes out}
a cup at round $t$ if the emptier empties, on round $t$, from a cup with fill
at state $I_t$ that is less than $1$. Note that on any round where the emptier
zeroes out a cup the emptier has removed less fill than the filler has added;
hence the average fill will increase. This concludes the round; the state of
the game is now $S_{t+1}$.

Denote the fill of a cup $c$ by $\fil(c)$. Let the \defn{positive tilt} of a cup $c$ be
$\tilt(c) = \max(0, \fil(c))$. Let the \defn{mass} of a set of cups $X$
be $m(X) = \sum_{c\in X} \fil(c)$. 
Let the positive tilt of a set $X$ of cups be $\tilt(X) = \sum_{c\in X} \tilt(c)$. 
Denote the average fill of a set of cups $X$
by $\mu(X)$. Note that $\mu(X) |X| = m(X)$.

Let the \defn{rank} of a cup at a given state be its position in a list of the
cups sorted by fill at the given state, breaking ties arbitrarily but
consistently. For example, the fullest cup at a state has rank $1$, and the
least full cup has rank $n$. Let $[n] = \{1,2,\ldots, n\}$, let $i+[n] = \{i+1, i+2, \ldots, i+n\}$.

Many of our lower bound proofs will adopt the convention of allowing for
negative fill. We call this the \defn{negative-fill variable-processor cup
game}. Specifically, in the negative-fill variable-processor cup game, when the
emptier empties from a cup its fill always decreases by exactly $1$: there is
no zeroing out. Negative-fill can be interpreted as fill below some average
fill. Measuring fill like this is important however, as our lower bound results
are used recursively, building on the average fill already achieved. Note that
it is strictly easier for the filler to achieve high backlog when cups can zero
out, because then some of the emptiers resources are wasted. On the other hand,
during the upper bound proof we show that a greedy emptier maintains the
desired invariants even if cups zero out. This is crucial as the game is harder
for the emptier when cups can zero out.

% When measuring fill relative to average fill, we will reference the actual --
% i.e. non-relative -- fills by calling them \defn{absolute} fills.

\section{Adaptive Filler Lower Bound}\label{sec:adaptive}
\begin{proposition}
\label{prop:adaptiveBase}
  There exists an adaptive filling strategy for the negative-fill
  variable-processor cup game on $n$ cups that achieves backlog at least
  $\frac{1}{4}\ln (n/2)$.
\end{proposition}
\begin{proof}
  Let $h = \frac{1}{4}\ln (n/2)$ be the desired fill. Once a cup with fill at
  least $h$ is achieved the filler stops, the process completed.  
  Let $A$ consist of the $n/2$ fullest cups, and $B$ consist of the rest of the
  cups. Note that $A, B$ are implicitly functions of the round $t$.

  If the process is not yet complete, that is $\fil(c) < h$ for all cups $c$,
  then $\tilt(A\cup B) < h\cdot n$. Assume for sake of contradiction that there
  are more than $n/2$ cups $c$ with $\fil(c) \le -2h$. The mass of those cups
  would be at most $-hn$ but the mass of the remaining cups cannot exceed
  $hn/2$. This implies that average fill is negative when it is in fact $0$ by
  definition, a contradiction. Hence there are at most $n/2$ cups $c$ with
  $\fil(c) \le -2h$. 

  The filler sets the number of processors equal to $1$ and plays a single
  processor cup game on $n/2$ cups that each have fill at least $-2h$ (which
  must exist) for $n/2 -1$ steps. Throughout this process the filler maintains
  a set of cups called the \defn{active set}: the set of cups that the filler
  will place fill in. The filler initializes the active set to be $A$. Note
  that that $\fil(c) \ge -2h$ for all cups $c\in A$, as $A$ consists of the
  $n/2$ fullest cups. The filler removes $1$ cup from the active set at each
  step. At each step the filler distributes water equally among the cups in its
  active set. Then, the emptier will choose some cup to empty from. If this cup
  is in the active set, the filler removes it from the active set. Otherwise,
  the filler chooses an arbitrary cup to remove from the active set.

  After $n/2-1$ steps, the active set will consist of a single cup. This cup's
  fill has increased by $1/(n/2) + 1/(n/2 - 1) + \cdots + 1/2 + 1/1 \ge \ln n/2
  = 4h$. This cup's fill started as at least $-2h$. Thus this cup has fill at
  least $2h$ now, as desired.
\end{proof}

\begin{lemma}[Adaptive Amplification Lemma]\label{lem:adaptiveAmplification}
  Let $f$ be an adaptive filling strategy that achieves backlog $f(n) \le n$ in the
  negative-fill variable-processor cup game on $n$ cups in running time $T(n)$.
  Let $\delta\in(0,1)$ be a parameter, and let $L\in\mathbb{N}$ be a parameter.
  \footnote{Note that $n$ must be sufficiently large, and $\delta, L$ must be
  chosen such that $(1-\delta)\delta^L n \in \mathbb{N}$ because it doesn't
  make sense to talk of ``fractional cups".}

  Then, there exists an adaptive filling strategy that achieves backlog 
  $$f'(n) \ge (1-\delta)\sum_{\ell= 0}^{L} f((1-\delta)\delta^\ell n)$$
  in the negative-fill variable-processor cup game on $n$ cups in running time 
  $$T'(n) \le L n^2 T((1-\delta)n).$$
\end{lemma}
\begin{proof}
  First we motivate the lemma's name: \defn{The Amplification Lemma}. Let
  $\alpha \in (0,1)$ be some constant. Then 
  \begin{equation}
    \label{eq:amplemmanamemotivation}
  (1-\delta) \sum_{\ell=0}^\infty (n(1-\delta)\delta^\ell)^\alpha = n^\alpha
  \frac{(1-\delta)^{\alpha+1}}{1-\delta^\alpha}.
  \end{equation}
  The right hand side of \eqref{eq:amplemmanamemotivation} can be made larger
  than $n^\alpha$ for fixed $\alpha$ and $\delta$ sufficiently small. 
  This motivates the notion of $f'$ being the \defn{amplification} of $f$: $f'$
  can be made larger than $f$. Note that of course we have not yet shown that
  it suffices to take a truncation of the infinite sum, or even that valid
  choices of $\delta, \alpha$ exist; we do this in the proof of Theorem
  \ref{thm:adaptivePoly}. Still, this observation motivates the Lemma.
  Further, note that the restriction $f(n) \le O(n)$ is reasonable because for
  $\alpha \ge 1$ the right side of \eqref{eq:amplemmanamemotivation} cannot be
  made larger than $n^\alpha$. For example, for $\alpha=1$ we have
  $$\frac{(1-\delta)^2}{1-\delta}n$$ which is smaller than $n$ for any $\delta
  \in (0,1)$. Also the restriction $f(n) \le n$ is not wasteful as we prove
  in Section \ref{sec:upperBound} that $O(n)$ is an upper bound on backlog.

  The basic idea of this analysis is as follows:\\
  \textbf{Step 1:} Using $f$ repeatedly, achieve average fill at least
  $(1-\delta) f(n(1-\delta))$ in a set of $n\delta$ cups. \\
  \textbf{Step 2:} Reduce the number of processors to $n\delta$, and recurse
  on the $n\delta$ cups with high average fill.

  Let $A$, the \defn{anchor set}, be initialized to consist of the $n\delta$
  fullest cups, and let $B$ the \defn{non-anchor set} be initialized to consist
  of the rest of the cups (so $|B| = (1-\delta)n$).
  Let $n_\ell = n\delta^{\ell-1}$, $h_\ell = (1-\delta)f(n_\ell(1-\delta))$;
  the filler will achieve a set of at least $n_\ell \delta$ cups with average
  fill at least $h_\ell$ on the $\ell$-th
  level of recursion. On the $\ell$-th level of recursion $|A| = \delta\cdot
  n_\ell, |B| = (1-\delta)\cdot n_\ell$.

  We now elaborate on how to achieve Step 1.
  The filling strategy always places $1$ unit of water in each anchor cup. This
  ensures that no cups in the anchor set ever have their fill decrease.

  On the $\ell$-th level of recursion the filler uses the following procedure,
  termed a \defn{swapping-process}, to achieve the desired average fill in $A$:
  repeatedly apply $f$ to $B$, and then take the cup generated by $f$ within
  $B$ with fill at least $f(|B|)$ and swap it with a cup in $A$; repeat until $A$ has
  the desired average fill. Note that $$\mu(A) \cdot |A| + \mu(B)\cdot |B| =
  0,$$ so $$\mu(A) = - \mu(B) \cdot (1-\delta)/ \delta.$$

  Thus, if at any point in the process $B$ has average fill lower than $-h_\ell
  \cdot \delta/(1-\delta)$, then $A$ has average fill at least $h_\ell$, so the
  process is finished. So long as $B$ has average fill at least $-h_\ell\cdot
  \delta/(1-\delta)$ the filler will applies $f$ to $B$.
  
  It is somewhat complicated to apply $f$ to $B$ however, because we must
  guarantee that the emptier removes the same mass from $B$ as the filler adds on
  all rounds during the filler's application of $f$ to $B$.
  This might not be the case if the emptier does not empty from each anchor cup
  at each step. We say that the emptier \defn{neglects} the anchor set on an
  application of $f$ if there is some step during the application of $f$ in
  which the emptier does not empty from some anchor cup.

  The filler applies $f$ to $B$ at most $n^2 +1 \ge h_\ell n_\ell\delta + 1$ times. 
  At the end of an application of $f$ the filler swaps the generated cup into $A$ only if the
  emptier has not neglected the anchor set during this application of $f$.

  Note that each time the emptier neglects the anchor set the mass of the
  anchor set increases by $1$. If the emptier neglects the anchor set $h_\ell
  n_\ell\delta + 1$ times, then the average fill in the anchor set increases by
  more than $h_\ell$, so the desired average fill is achieved in the anchor set.

  Otherwise, there must have been an application of $f$ for which the emptier
  did not neglect the anchor set. In this case the filler achieves fill 
  $$-h_\ell \cdot \delta/(1-\delta) + f(n_\ell (1-\delta)) = (1-\delta)f(n_\ell
  (1-\delta)) = h_\ell$$
  in some non-anchor cup, and swaps it with the least full cup in the anchor set.

  The filler achieves average fill $h_\ell$ in the anchor set for $L$ levels of
  recursion. Summing $h_\ell$ for $0\le \ell \le L$ yields the desired backlog.

  As for running time analysis, note that on the first level of recursion $f'$
  called $f$ on a set of size $(1-\delta)n$ as many as $n^2$ times. This
  contributes $n^2 T((1-\delta)n)$ to the running time. Terms at other levels
  of recursion are at most this, so the entire running time can be upper bounded by 
  $$T'(n) \le L n^2 T((1-\delta)n)$$
  as desired.

\end{proof}

\begin{theorem}
  \label{thm:adaptivePoly}
  There is an adaptive filling strategy for the variable-processor cup game on
  $n$ cups that achieves backlog $\Omega(n^{1-\epsilon})$ for any constant
  $\epsilon > 0$ of our choice in running time $2^{O(\log^2 n)}$.

  There is also an adaptive filling strategy for achieving backlog $\Omega(n)$
  in running time $2^{O(n)}$.
\end{theorem}
\begin{proof}
  Fix $\epsilon \in (0,1/2)$, and let $c, \delta$ be parameters, with $c\in
  (0,1), 0 < \delta \ll 1/2$ -- these will depend on $\epsilon, n$.
  Say that we aim to achieve backlog at least $cn^{1-\epsilon}$.
  Observe that if we apply the Amplification Lemma to a function $f$ satisfying
  $f(k) \ge ck^{1-\epsilon}$ for $k \le g$ then for any $k_0$ with
  $k_0(1-\delta)\le g$ (which enforces $k_0 \le g/ (1-\delta)$) we have the
  following:
  \begin{align*}
  f'(k_0)\ge&\\
  &(1-\delta)\sum_{\ell=0}^L c (((1-\delta)\delta^\ell)k_0)^{1-\epsilon}\\
  &= ck_0^{1-\epsilon} (1-\delta)^{2-\epsilon} \sum_{\ell=0}^L (\delta^\ell)^{1-\epsilon},
  \end{align*}
  for appropriate choice of $L$.
  We will choose $\delta$ to be very small, so $\sum_{\ell=0}^L
  (\delta^L)^{1-\epsilon}$ is well approximated by
  $1+\delta^{1-\epsilon}$, and thus we don't lose much by relaxing our lower
  bound on $f'(k_0)$ to only using $L=1$ (i.e. taking two terms of the sum). We have the bound
  $$f'(k_0) \ge ck_0^{1-\epsilon}(1-\delta)^{2-\epsilon}(1+\delta^{1-\epsilon}).$$
  Let 
  $$h(\delta) = (1-\delta)^{2-\epsilon}(1+\delta^{1-\epsilon}).$$
  We prove the following claim:

  \begin{clm}
    \label{clm:validchoices}
    There exists an appropriate choice of $\delta$ that is small enough such
    that $h(\delta) \ge 1$ and large enough such that $(1-\delta)\delta n \ge
    n_0$, when $\epsilon$ is chosen to be $4/\lg n$, or a positive constant. 

    In particular, if $\epsilon$ is chosen to be $4/\lg n$ then we will choose
    $\delta =\Theta(1/n)$, and if $\epsilon$ is chosen to be a positive
    constant then we will choose $\delta = \Theta(1)$.
  \end{clm}

  Note that in order for $L =1$ to make sense it must be that
  $n(1-\delta)\delta n \ge n_0$, or else this term from the sum would be
  contributing essentially $0$ backlog to the sum.
  If $L=1$ and if $h(\delta)\ge 1$, then $f'(k_0) \ge c k_0^{1-\epsilon}$, meaning
  we have constructed from $f$ a new function $f'$ that satisfies the
  inequality $f'(k) \ge ck^{1-\epsilon}$ for $k\le g/(1-\delta)$, as opposed to
  only for $k \le g$ as in the case of $f$. 
  \footnote{Note that although $f'(k) \ge ck^{1-\epsilon}$ holds for at least
    as many $k$ as $f(k) \ge c k^{1-\epsilon}$, it does not necessarily hold
    for strictly more; in particular, if $\lfloor g/(1-\delta) \rfloor = g$
    then the inequality on $f'$ holds for no more $k$ than the inequality on
    $f$, as $f$ and $f'$ are functions on $\mathbb{N}$. In general we have to
    be somewhat careful about the fact that there are an integer number of cups
    throughout this proof (this issue was deferred from earlier proofs to be
  dealt with here).} 
  Thus by repeatedly amplifying a function, we should be able to arbitrarily
  extend the region where the function satisfies the desired inequality, which
  will allow us to attain the desired backlog.
  We now prove Claim \ref{clm:validchoices}.
  \begin{proof}
    First we show that making $h(\delta) > 1$ is possible.
  Consider the Taylor series for $(1-\delta)^{2-\epsilon}$ about $\delta = 0$:
  $$(1-\delta)^{2-\epsilon} = 1 - (2-\epsilon)\delta + O(\delta^2).$$
 
  So, to find a $\delta$ where $h(\delta) \ge 1$ it suffices -- note that we
  choose to neglect the $\delta^2$ term as it does not strengthen the lower
  bound substantially -- to find a $\delta$ with
  $$(1-(2-\epsilon)\delta)(1+\delta^{1-\epsilon}) \ge 1.$$
  Rearranging we have 
  $$\delta^{1-\epsilon} \ge (2-\epsilon)\delta + (2-\epsilon)\delta^{2-\epsilon}.$$
  This clearly is true for sufficiently small $\delta$, as
  $\delta^{1-\epsilon}$ will be much greater than $\delta$ or
  $\delta^{2-\epsilon}$.
  However it will be beneficial to have a more explicit criterion for possible
  choices of $\delta$ in terms of $\epsilon$. To get this, we enforce a 
  stronger inequality on $\delta^{1-\epsilon}$ by overestimating
  $\delta^{2-\epsilon}$ as $\delta$. 
  Then, $\delta$ satisfying
  \begin{equation}
    \label{eqn:deltaUpperIneq}
    \delta \le \frac{1}{(2(2-\epsilon))^{1/\epsilon}}
  \end{equation}
  will make $h(\delta) \ge 1.$

  In addition to the constraint that $\delta$ must be small enough such that
  $h(\delta) \ge 1$, the only other constraint on $\delta$ is that $\delta$
  must be large enough that the sum from the Amplification Lemma can have at least
  two terms, i.e. such that $L \ge 1$. We need $L\ge 1$ because otherwise the
  Amplification Lemma doesn't give a larger function.
  That is, we want
  $$\delta(1-\delta)n \ge n_0. $$
  Recall that we choose $\delta < 1/2$, so $1-\delta > 1/2$. Thus to make
  $\delta$ sufficiently big it suffices to chose $\delta$ with 
  \begin{equation}
    \label{eqn:deltaLowerBound}
    \delta \ge 2n_0/n.
  \end{equation}
  Any choice of $\delta$ that is sufficiently large to make $L \ge 1$ and
  simultaneously small enough to make $h(\delta) \ge 1$ is a valid choice of
  $\delta$. That is, $\delta$ is valid if and only if it satisfies
  \begin{equation}
    \label{eqn:deltainequality}
    \frac{2n_0}{n} \le \delta \le  \frac{1}{(2(2-\epsilon))^{1/\epsilon}}.
  \end{equation}
  To achieve the desired backlog of $\Omega(n)$ we can use $\epsilon =
  \gamma/\lg n$ for appropriate constant $\gamma$, as $$n^{1-\gamma/\lg n} =
  n/2^\gamma = \Omega(n).$$
  We show that there is a valid choice of $\gamma$ such that the following inequality is satisfied:
  \begin{equation}
    \label{eqn:thatinequality}
   2n_0/n \le \frac{1}{(2(2-\gamma/\lg n))^{(1/\gamma)\lg n}}.
  \end{equation}
  Note that 
  $$(2(2-\gamma/\lg n))^{(1/\gamma)\lg n} \le 4^{(1/\gamma)\lg n} \le n^{2/\gamma}.$$
  Thus, clearly by choosing e.g. $\gamma = 4$ we have the desired inequality.
  Inequality \ref{eqn:thatinequality} implies that there is a valid choice of
  $\delta$ when we chose $\epsilon = \gamma / \lg n$. When proving that we can
  achieve backlog $\Omega(n)$ we use $\epsilon = 4 / \lg n$, and $\delta =
  O(1/n)$ satisfying Inequality \ref{eqn:deltainequality} for our choice
  of $\epsilon$. When proving that we can achieve backlog
  $\Omega(n^{1-\epsilon})$ for constant $\epsilon > 0$ we choose $\delta > 0$ to be
  a constant satisfying Inequality \ref{eqn:deltaUpperIneq}, and $\delta$,
  being constant, trivially satisfies Inequality \ref{eqn:deltaLowerBound}.
    
  \end{proof}

  Now we proceed to show that with the appropriate values of $\delta, \epsilon$ we
  can achieve a filling strategy that achieves backlog $cn^{1-\epsilon}$ on $n$ cups.
  First we present a simple existential argument to show that an algorithm
  achieving backlog $\Omega(n^{1-\epsilon})$ for $\epsilon$ constant exists. Next we modify the
  existential proof to achieve an algorithm achieving the same backlog, but in
  bounded running time, specifically running time $2^{O(\log^2 n)}$.
  Finally we present an algorithm where $\delta$ is set extremally; doing so,
  along with other modifications of the approach, we can achieve backlog
  $\Omega(n)$ in running time $2^{O(n)}$.
  
  \begin{proposition}
    There exists an adaptive filling strategy that achieves backlog
    $\Omega(n^{1-\epsilon})$ for any constant $\epsilon > 0$.
  \end{proposition}
  \begin{proof}
  Let $\epsilon > 0$ be constant. By Claim \ref{clm:validchoices}, there is a
  valid constant setting of $\delta$; let $\delta \ll 1/2$ be an appropriate
  constant. Let $f^*(n)$ be the supremum over all filling strategies of the
  backlog achievable on $n$ cups. Clearly $f^*$ must be greater than or equal to
  the amplification of $f^*$. Assume for contradiction that there is some least
  $n_*$ such that 
  $$\begin{cases}
    f^*(k)< ck^{1-\epsilon}, & k > n_*\\
    f^*(k)> ck^{1-\epsilon}, & k \le n_*
  \end{cases} $$
  Note that $n_*(1-\delta)\delta \ge n_0/(1-\delta)$ by appropriate choice of constant
  $c$, and Proposition \ref{prop:adaptiveBase}, which states that we can get
  backlog $\Omega(\log n_*)$ on $n_*$ cups\footnote{Note: this is where it is
  crucial that $\epsilon, \delta$ are constants.}.
  Because $f^*$ satisfies the Amplification Lemma we have:
\begin{align*}
  f^*(n_*) & \\
           &\ge (1-\delta)\sum_{\ell=0}^L f^*((1-\delta)\delta^\ell n_*) \\
           &\ge cn_*^{1-\epsilon} h(\delta)\\
           &\ge cn_*^{1-\epsilon}
\end{align*}
which is a contradiction. Hence $f^*$ achieves backlog $cn^{1-\epsilon}$.
    
  \end{proof}

  \begin{proposition}
    \label{prop:constructive_nepsil}
    There is an adaptive filling strategy that achieves backlog
    $\Omega(n^{1-\epsilon})$ for constant $\epsilon > 0$ in time $2^{O(\log^2 n)}$.
  \end{proposition}
  \begin{proof}
It is desirable to have an algorithm for achieving this backlog with bounded
running time; we now modify the existential argument to make it constructive, 
which yields an algorithm for achieving backlog $cn^{1-\epsilon}$ on $n$ cups 
in quasi-polynomial running time. We again use constant $\epsilon > 0$ and appropriate constant $\delta$.

  We start with the algorithm given by Proposition \ref{prop:adaptiveBase} for achieving backlog
  $$f_0(k) = 
  \begin{cases} 
    \lg k, & k\geq 1, \\
    0 & \text{else.}
  \end{cases}$$
  Then we construct an algorithm that achieves better backlog using the
  Amplification Lemma (Lemma \ref{lem:adaptiveAmplification}):
  we construct $f_{i+1}$ as the amplification of $f_{i}$. 

  Define a sequence $g_i$ with 
  $$ g_i = \begin{cases}
    \lceil 1/\delta \rceil \gg 1,  & i = 0,\\
    \lceil g_{i-1}/(1-\delta)\rceil -1 & i  \ge 1
  \end{cases} $$
  That is, $g_{i+1}$ is the greatest integer strictly less than $g_i/(1-\delta)$.
  Note that $ (1/\delta) / (1-\delta) > (1+\delta)/\delta = 1/\delta + 1.$
  Thus $g_1 = 1+ g_0$, and in general, $g_{i+1} > g_i$, because the difference
  $g_{i+1}-g_i$ can only grow as $i$ grows.

  We claim the following regarding this construction:
  \begin{clm}
    \label{clm:fikinduction}
  \begin{equation}
    f_i(k) \ge ck^{1-\epsilon} \text{ for all } k < g_i. 
  \end{equation}
  \end{clm}
  \begin{proof}
  We prove Claim \ref{clm:fikinduction} by induction on $i$.
  Claim \ref{clm:fikinduction} is true in the base case of $f_0$ by taking $c$
  sufficiently small, in particular small enough that $f_0(k) \ge
  ck^{1-\epsilon}$ holds for $k < g_0$.\footnote{Note: this is where it is
    crucial that $\epsilon, \delta$ are constants.}
  As our inductive hypothesis we assume Claim \ref{clm:fikinduction} for $f_i$;
  we aim to show that Claim \ref{clm:fikinduction} holds for $f_{i+1}$. Note
  the key property of $g_i$, that $g_{i+1}\cdot(1-\delta) < g_i$. Also note
  that (at least without loss of generality) the $f_i$ are monotonically increasing
  functions: given more cups we can always achieve higher fill than with fewer
  cups. Thus we have, for any $k<g_{i+1}$,
  \begin{align*}
    f_{i+1}(k) &\\
    &\ge (1-\delta)\sum_{\ell=0}^L f_i((1-\delta)\delta^\ell k)\\
    &\ge ck^{1-\epsilon}h(\delta)\\
    &\ge ck^{1-\epsilon},
  \end{align*}
  as desired. 
  \end{proof}

  Note that $g_{i+1} \ge g_i + 1$ so by continuing this process we eventually
  reach some $f_{i_*}$ such that $f_{i_*}(n) \ge cn^{1-\epsilon}$; trivially
  $i_* \le n$. In fact we can show $i_* \le O(\log n)$. The recurrence is
  almost simply the geometric sequence $g_i = g_{i-1}/(1-\delta)$ with
  $g_0=1/\delta$, for which it is trivially true that $g_i = 1/\delta
  (1/(1-\delta))^i$, hence we would have $g_{\log_{1/(1-\delta)} n} = n\cdot 1/\delta > n$ as
  desired. The actual sequence is not quite this large. The sequence is lower
  bounded by the sequence $g_i'$ defined as $g_0'=1/\delta, g_i' = g_{i-1}' /
  (1-\delta) -1$. Even the sequence $g_i'$ grows exponentially though, hence
  only a logarithmic recursion depth is necessary. In particular, $g_i'$ satisfies
  $$g_i' = \frac{1/\delta}{(1-\delta)^i} - \frac{1/(1-\delta)^{i-1}-1}{1/(1-\delta)-1},$$
  which simplifies to
  $$g_i' = \frac{1}{(1-\delta)^i} + \frac{1-\delta}{\delta}.$$
  Thus $g_{\log_{1/(1-\delta)} n}'$, and hence also $g_{\log_{1/(1-\delta)} n}$
  both are at least $n$, as desired.

  However, we have not addressed the issue that the number of cups must be an
  integer! Although it is relatively clear that this will not affect the
  asymptotic results, we briefly carefully address this here. Luckily, by
  careful choice of $\delta$ and a slight (constant factor) reduction of $n$ we can get the
  argument to work. In particular, let $\psi$ be the smallest natural such that
  $1/2^\psi < \delta$; define $\delta' = 1/2^\psi$. Let $\tau$ be the integer
  such that $2^{\tau \psi} \le n < 2^\psi 2^{\tau \psi}$; define $n' =
  2^{\tau\psi}$. Note that $O(n') = O(n)$ as $n'$ is at worst a factor of
  $2^\psi$ less than $n$, but $\delta$ being constant implies that $\psi$ is
  also constant. Note that $$\tau = \Big\lfloor \frac{\lg n}{\psi} \Big\rfloor \ge \Omega(\log n).$$
  Thus, we have that $n'(\delta')^{i_1}(1-\delta')^{i_2} \in \mathbb{N}$ for any
  integers $i_1,i_2$ satisfying $i_1+i_2 \le \tau$, which means that $i_1,i_2\ge \Omega(\log n)$ is possible.
  Now we can genuinely guarantee that throughout the levels of recursive application of
  the Amplification Lemma -- of which there will be at most $O(\log n)$-- the
  number of cups is always an integer. 

  Let the running time $f_{i_*}(n)$ be $T(n)$. From the Amplification Lemma we have 
  following recurrence bounding $T(n)$ (setting $L=1$):
  $$T(n) \le 2n^2 \cdot T(n(1-\delta)).$$
  Continuing for $O(\log n)$ levels of recursion is sufficient to
  achieve the desired backlog. This gives running time
  $$T(n) \le (2n^2)^{O(\log n)} \le 2^{O(\log^2 n)}$$
  as desired.
    
  \end{proof}

  \begin{proposition}
    There is an adaptive filling strategy that achieves backlog $\Omega(n)$ in
    time $2^{O(n)}$.
  \end{proposition}
  \begin{proof}
  % We describe a simple filling strategy that gives the desired backlog. Let
  % $n_0 \le O(1)$ be a constant such that we can achieve backlog $1$ on $n_0$
  % cups, and note that this is possible by Proposition \ref{prop:adaptiveBase}.
  % We construct a function that achieves large backlog on $n$ cups.
  % To achieve large backlog on $n$ cups we first recursively apply our function to
  % $(1-\delta)n$ cups repeatedly (for each of the $\delta n$ cups that we are
  % attempting to get high fill in), as described in the proof of the
  % Amplification Lemma, and transfer over the cups that we get. Then we achieve backlog $1$ on
  % the $\delta n$ cups whose average fill has been increased. The backlog we
  % achieve satisfies the following recurrence:
  % $$f(n) \ge \begin{cases}
  %   (1-\delta)f((1-\delta)n) + 1, & \text{if } n\delta(1-\delta) > n_0\\
  %   0, \text{ else.}
  % \end{cases}$$
  % Let $(1-\delta)^c = \delta$, let $\delta^2 n < n_0 < (1-\delta)^{2c-1} n$ by
  % our choice of $\delta = \Theta(1/n)$.
  %   We can get backlog 
  %   $$\sum_{i=1}^c (1-\delta)^i. $$
  %   To see this, consider a binary tree representing our algorithm. At every
  %   branch we both proceed to recurse on a $1-\delta$ fraction of the cups, and
  %   achieve backlog $1$ on a $\delta$ fraction of the cups.
  %   The sum evaluates to 
  %   $$\frac{(1-\delta)^2}{\delta}$$
  %   which, if we chose $\delta = \Theta(1/n)$, becomes $\Omega(n)$.
  %   The running time satisfies the recurrence 
  %   $$T(n) = \delta n T((1-\delta)n) + O(1)$$
  %   because to achieve backlog $f(n)$ we must achieve backlog
  %   $f((1-\delta)n)$ $\delta n$ times, and then achieve backlog $1$ on the
  %   remaining cups. Solving this recurrence yields that the running time is
  %   $$\frac{(\delta n)^c - 1}{\delta n - 1}.$$
  %   Recalling that $\delta = O(1/n)$ this becomes 
  %   $$2^{O(n)}.$$
    % We can even express this strategy more simply.
    We now describe an algorithm $f$ that achieves backlog 
    $$f(k) = \begin{cases}
      \left(1-\frac{n_0}{k}\right)f(k-n_0) + 1, &k \ge 2n_0\\
      1,  &n_0\le k < 2n_0 \\
      0, &k< n_0.
    \end{cases}$$
    Clearly our strategy is possible for $k<2n_0$ by Proposition \ref{prop:obliviousBase}.
    Assuming that our algorithm works for $k<mn_0$ we can extend it to work for
    $k<(m+1)n_0$ by considering the amplification of our algorithm using $\delta = n_0/n$.
    By induction our algorithm thus works for all $n$.

    Expanding the recurrence, we find that our algorithm achieves backlog 
    $$f(n) = 1+ 1-\frac{n_0}{n} + 1-\frac{n_0}{n-n_0} + 1-\frac{n_0}{n-2n_0} + \cdots $$
    Clearly 
    $$f(n) \ge n - n_0 \log n \ge \Omega(n).$$

    The recurrence for running time is 
    $$T(n) = n_0T(n-n_0)+O(1).$$
    Clearly $T(n) = 2^{O(n)}$.

    This algorithm can be interpreted very simply. To achieve large backlog on
    $n$ cups we create an anchor set $A$ of $n_0$ cups and a set $B$ of $n-n_0$
    cups; We recursively apply our strategy to $B$ for each cup in $A$. In
    order for the average fill difference between $A$ and $B$ to be $f(n-n_0)$,
    $\mu(A)$ must rise by $\frac{n-n_0}{n}$ of this difference whereas $\mu(B)$
    must sink by $\frac{n_0}{n}$ of this difference. Hence we achieve average
    fill $\frac{n-n_0}{n}f(n-n_0)$ in $A$. Then, using the strategy from
    Proposition \ref{prop:adaptiveBase} we can achieve backlog $1$ on these
    cups. The Amplification Lemma makes this argument rigorous.

    % Our strategy achieves backlog $f(n)$ on $n$ cups. We consider our strategy
    % to be it's own Amplification with $\delta = n_0/n$. In particular, this
    % means that we apply $f$ to $n-n_0$ cups $n_0$ times, and achieve a cup with
    % fill at least $\left(1-\frac{n_0}{n}\right)f(n-n_0)$ with each application of $f$. 
    % Then, we recurse on the set of $n_0$ cups with high average fill, and achieve backlog at least $1$ on them.
    % Hence the backlog that we achieve over all satisfies the recurrence 

    % Our strategy for achieving backlog $f$ is to split the cups into a set of
    % the $n_0$ fullest cups and the other $n-n_0$ cups. We apply 
    % , we apply our function recursively to
    % $n-n_0$ cups $n_0$ times to achieve fill $(1-n_0/n)f(n-n_0)$ in a set of
    % $n_0$ cups, and then we apply the strategy from Proposition
    % \ref{prop:adaptiveBase} to these cups. Hence the backlog achieved satisfies the recurrence
    % $$f(n) = (1-n_0/n)f(n-n_0) + 1.$$
    % Solving the recurrence, if we expand out $\Omega(n)$ terms then we get a sum of $\Omega(n)$ as desired.
    % The recurrence for running time is 
    % $$T(n) = n_0T(n-n_0)+1.$$
    % Solving, we again get $2^{O(n)}$.
  \end{proof}


\end{proof}

\section{Upper Bound}\label{sec:upperBound}

In this section, we analyze the \defn{greedy emptier}, which always empties
from the $p$ fullest cups. We prove (in Corollary \ref{cor:upperbound} that the
greedy emptier prevents backlog from exceeding $O(n)$. 

In order to analyze the greedy emptier, we establish a system of invariants
that hold at every step of the game. 

Let $\mu_S(X)$ and $m_S(X)$ denote the average fill and the mass, respectively,
of a set of cups $X$ at state $S$ (e.g. $S=S_t$ or $S=I_t$).\footnote{Note that
  in the lower bound proofs (i.e. Section \ref{sec:adaptive} and Section
  \ref{sec:oblivious}) when we use the notation $m$ (for mass) and $\mu$ (for
average fill), we omit the subscript indicating the state at which the
properties are measured. In those proofs the state is implicitly clear.
However, in this section it will be useful to make the state $S$ explicit in
the notation.} Let $S(\{r_1, \ldots, r_m\})$ denote the set of cups of ranks
$r_1, r_2, \ldots, r_m$ at state $S$. We will use concatenation of sets to
denote unions, i.e. $AB = A\cup B$. 

The main result of the section is the following theorem.  
\begin{theorem}
  \label{thm:invariant}
  In the variable-processor cup game on $n$ cups, the greedy emptier maintains, at every step $t$,
  the invariants
  \begin{equation}
    \label{eq:invariants}
      \mu_{S_t}(S_t([k])) \le 2n-k
  \end{equation}
  for all  $k \in [n]$.
\end{theorem}

By applying Theorem \ref{thm:invariant} to the case of $k = 1$, we arrive at a bound on backlog:
\begin{corollary}
  On a game with $n$ cups, the greedy emptying strategy achieves backlog $O(n)$.
  \label{cor:upperbound}
\end{corollary}

\begin{proof}[Proof of Theorem \ref{thm:invariant}]
We prove the invariants by induction on $t$.
The invariants hold trivially for $t=1$ (the base case for the inductive proof): 
the cups start empty so $\mu_{S_1}(S_1([k])) = 0 \le 2n-k$ for all $k \in [n]$.

Fix a round $t \ge 1$, and any $k \in [n]$. We assume the invariants for all
values of $k' \in[n]$ for state $S_t$ (we will only explicitly use two of the
invariants for each $k$, but the invariants that we need depend on the
choice of $p_t$ by the filler) and show that
the invariant on the $k$ fullest cups holds on round $t+1$, i.e. that
$$\mu_{S_{t+1}}(S_{t+1}([k])) \le 2n-k.$$

Note that because the emptier is greedy it always empties from the cups
$I_t([p_t])$. Let $A$, with $a=|A|$, be $A = I_t([\min(k, p_t)]) \cap
S_{t+1}([k])$; $A$ consists of the cups that are among the $k$ fullest cups in
$I_t$, are emptied from, and are among the $k$ fullest cups in $S_{t+1}$. Let
$B$, with $b=|B|$, be $I_t([\min(k, p_t)]) \setminus A$; $B$ consists of the
cups that are among the $k$ fullest cups in state $I_t$, are emptied from, and
are not among the $k$ fullest cups in $S_{t+1}$. Let $C = I_t(a+b+[k-a])$, with
$c=k-a = |C|$; $C$ consists of the cups with ranks $a + b + 1, \ldots, k + b$
in state $I_t$. The set $C$ is defined so that $S_{t+1}([k]) = AC$, since once
the cups in $B$ are emptied from, the cups in $B$ are not among the $k$ fullest
cups, so cups in $C$ take their places among the $k$ fullest cups.

Note that $k-a \ge 0$ as $a+b \le k$, and also $|ABC| = k+b \le n$, because by
definition the $b$ cups in $B$ must not be among the $k$ fullest cups in state
$S_{t+1}$ so there are at least $k+b$ cups. 
Note that $a + b = \min(k, p_t)$. We also have that $A = I_t([a])$ and $B =
I_t(a+[b])$, as every cup in $A$ must have higher fill than all cups in $B$ in
order to remain above the cups in $B$ after $1$ unit of water is removed from
all cups in $AB$.

We now establish the following claim, which we call the \defn{interchangeability of cups}:
\begin{clm}
  \label{clm:interchangable}
  There exists a cup state $S_t'$ such that: (a) $S_t'$ satisfies the
  invariants \eqref{eq:invariants}, (b) $S_t'(r) = I_t(r)$ for all ranks
  $r\in[n]$, and (c) the filler can legally place water into cups in order to
  transform $S_t'$ into $I_t$. 
\end{clm}
\begin{proof}
  Fix $r \in [n]$. We will show that $S_t$ can be transformed into a state
  $S_t^r$ by relabelling only cups with ranks in $[r]$ such that (a) $S_t^r$
  satisfies the invariants \eqref{eq:invariants}, (b) $S_t^r([r]) = I_t([r])$
  and (c) the filler can legally place water into cups in order to transform
  $S_t^r$ into $I_t$.

Say there are cups $x, y$ with $x\in S_t([r]) \setminus I_t([r]), y \in
 I_t([r])\setminus S_t([r])$. Let the fills of cups $x,y$ at state $S_t$
 be $f_x, f_y$; note that 
 \begin{equation}
     f_x > f_y.
     \label{eq:fxfy}
 \end{equation} Let the amount of fill that the filler
 adds to these cups be $\Delta_x, \Delta_y \in [0,1]$; note that 
 \begin{equation}
 f_x +\Delta_x <f_y + \Delta_y.
 \label{eq:fxdxfydy}
 \end{equation}
 
Define a new state $S_t'$ where cup $x$ has fill $f_y$ and cup $y$ has fill
$f_x$. Note that the filler can transform state $S_t'$ into state $I_t$ by
placing water into cups as before, except changing the amount of water placed
into cups $x$ and $y$ to be  $f_x-f_y+\Delta_x$ and $f_y-f_x + \Delta_y$,
respectively.

In order to verify that the transformation from $S_t'$ to $I_t$ is a valid step
for the filler, one must check three conditions. First, the amount of water
placed by the filler is unchanged: this is because $(f_x-f_y + \Delta_x) +
(f_y-f_x+\Delta_y) = \Delta_x + \Delta_y$. Second, the fills placed in cups $x$
and $y$ are at most $1$: this is because $f_x-f_y+\Delta_x<\Delta_y \le 1$ (by
\eqref{eq:fxdxfydy}) and $f_y-f_x + \Delta_x < \Delta_x \le 1$ (by
\eqref{eq:fxfy}). Third, the fills placed in cups $x$ and $y$ are non-negative:
this is because $f_x-f_y + \Delta_x > \Delta_x \ge 0$ (by \eqref{eq:fxfy})
and $f_y-f_x+\Delta_y > \Delta_x \ge 0$ (by
\eqref{eq:fxdxfydy}). 

We can repeatedly apply this process to swap each cup in $I_t([r])\setminus
S_t([r])$ into being in $S_t'([r])$. At
the end of this process we will have some state $S_t^r$ for which
$S_t^r([r]) = I_t([r])$. Note that $S_t^r$ is simply a relabeling of $S_t$,
hence it must satisfy the same invariants \eqref{eq:invariants} satisfied by
$S_t$. Further, $S_t^r$ can be transformed into $I_t$ by a valid filling step.

Now we repeatedly apply this process, in descending order of ranks. 
In particular, we have the following process: create a sequence of states by
starting with $S_t^{n-1}$, and to get to state $S_t^{r}$ from state $S_t^{r+1}$
apply the process described above. 
Note that $S_t^{n-1}$ satisfies $S_t^{n-1}([n-1]) = I_t([n-1])$ and thus also
$S_t^{n-1}(n) = I_t(n)$.
If $S_t^{r+1}$ satisfies $S_t^{r+1}(r') = I_t(r')$ for all $r'>r+1$ then
$S_t^r$ satisfies $S_t^r(r') = I_t(r')$ for all $r > r$, because the transition
from $S_t^{r+1}$ to $S_t^r$ has not changed the labels of any cups with ranks
in $(r+1, n]$, but the transition does enforce $S_t^r([r]) = I_t([r])$, and
consequently $S_t^r(r+1) = I_t(r+1)$.
We continue with the sequential process until arriving at state $S_t^1$ in
which we have $S_t^1(r) = I_t(r)$ for all $r$.
Throughout the process each $S_t^r$ has satisfied the invariants
\eqref{eq:invariants}, so $S_t^1$ satisfies the invariants
\eqref{eq:invariants}. Further, throughout the process from each $S_t^r$ it is
possible to legally place water into cups in order to transform $S_t^r$ into
$I_t$.

Hence $S_t^1$ satisfies all the properties desired, and the proof of Claim
\ref{clm:interchangable} is complete.

\end{proof}

Claim \ref{clm:interchangable} tells us that we may assume without loss of
generality that $S_t(r) = I_t(r)$ for each rank $r \in [n]$. We will make
this assumption for the rest of the proof. 

In order to complete the proof of the theorem, we break it into three cases. 

\begin{clm}
  If some cup in $A$ zeroes out in round $t$, then the invariant
  $\mu_{S_{t+1}}(S_{t+1}([k])) \le 2n-k$ holds.
\end{clm}
\begin{proof}
  Say a cup in $A$ zeroes out in step $t$. 
  Of course
  $$m_{S_{t+1}}(I_t([a-1])) \le (a-1)(2n-(a-1))$$
  because the $a-1$ fullest cups must have satisfied the invariant (with $k = a - 1$) on round
  $t$. Moreover, because $\fil_{S_{t+1}}(I_{t+1}(a)) = 0$
  $$m_{S_{t+1}}(I_t([a])) = m_{S_{t+1}}(I_t([a-1])).$$
  Combining the above equations, we get that
  $$m_{S_{t+1}}(A) \le (a-1)(2n-(a-1)).$$
  Furthermore, the fill of all cups in $C$ must be at most $1$ at state $I_t$ to be
  less than the fill of the cup in $A$ that zeroed out. Thus, 
  \begin{align*}
      m_{S_{t+1}}(S_{t+1}([k])) & = m_{S_{t + 1}}(AC)\\ 
                                & \le (a-1)(2n-(a-1))+k-a\\
                                &= a(2n-a) +a -2n+a-1 + k -a\\
                                &= a(2n-a) + (k-n) + (a-n) -1\\
                                &< a(2n-a)
  \end{align*}
  as desired. As $k$ increases from $1$ to $n$, $k(2n-k)$ strictly increases (it is a
  quadratic in $k$ that achieves its maximum value at $k=n$).
  Thus $a(2n-a) \le k(2n-k)$ because $a\le k$.
  Therefore,
  $$m_{S_{t+1}}(S_{t+1}([k])) \le k(2n-k).$$
\end{proof}

\begin{clm}
  If no cups in $A$ zero out in round $t$ and $b=0$, then the invariant
  $\mu_{S_{t+1}}(S_{t+1}([k])) \le 2n-k$ holds.
\end{clm}
\begin{proof}
If $b=0$, then $S_{t+1}([k]) = S_t([k])$. 
During round $t$ the emptier removes $a$ units of fill from the cups in $S_t([k])$,
specifically the cups in $A$. The filler cannot have added more than $k$ fill
to these cups, because it can add at most $1$ fill to any given cup. Also, the
filler cannot have added more than $p_t$ fill to the cups because this is the
total amount of fill that the filler is allowed to add. Hence the filler adds
at most $\min(p_t, k) = a+b=a+0=a$ fill to these cups.
Thus the invariant holds:
$$m_{S_{t+1}}(S_{t+1}([k])) \le m_{S_t}(S_t([k]))+a-a \le k(2n-k).$$
\end{proof}

The remaining case, in which no cups in $A$ zero out and $b > 0$ is the most technically interesting.
\begin{clm}
  If no cups in $A$ zero out on round $t$ and $b > 0$, then the invariant
  $\mu_{S_{t+1}}(S_{t+1}([k])) \le 2n-k$ holds.
\end{clm}
\begin{proof}
Because $b>0$ and $a+b \le k$ we have that $a
< k$, and $c = k-a > 0$. Recall that $S_{t+1}([k]) = AC$, so the mass of the
$k$ fullest cups at $S_{t+1}$ is the mass of $AC$ at $S_t$ plus any water added
to cups in $AC$ by the filler, minus any water removed from cups in $AC$ by the
emptier. The emptier removes exactly $a$ units of water from $AC$.
The filler adds no more than $p_t$ units of water to $AC$ (because the filler
adds at most $p_t$ total units of water per round) and the filler also
adds no more than $k = |AC|$ units of water to $AC$ (because the filler adds
at most $1$ unit of water to each of the $k$ cups in $AC$).
Thus, the filler adds no more than $a+b = \min(p_t, k)$ units of water to $AC$.
Combining these observations we have:
\begin{equation}
m_{S_{t+1}}(S_{t+1}([k])) \le m_{S_t}(AC) + b.
\label{eq:emptiereptiessomestufffillerfillssomestuff}
\end{equation}

% This is easy to bound if $m_{S_t}(C) \le m_{S_t}(BC) - b$, because 
% $$m_{S_t}(A) + m_{S_t}(BC)  = m_{S_t}(ABC) \le m_{S_t}([k])$$
% which would imply the invariant for $S_{t+1}$, $k$.
% If $\mu_{S_t}(C)$ is not significantly less than $\mu_{S_t}(BC)$ we have more difficulty.
The key insight necessary to bound this is to notice that larger values for
$m_{S_t}(A)$ correspond to smaller values for $m_{S_t}(C)$ because of the
invariants; the higher fill in $A$ \defn{pushes down} the fill that $C$ can
have. By capturing the pushing-down relationship combinatorially we will achieve the desired inequality.

We can upper bound $m_{S_t}(C)$ by 
\begin{align*}
m_{S_t}(C) & \le \frac{c}{b+c}m_{S_t}(BC) \\
&= \frac{c}{b+c}(m_{S_t}(ABC) - m_{S_t}(A))
\end{align*}
 because
$\mu_{S_t}(C) \le \mu_{S_t}(B)$ without loss of generality by the
interchangeability of cups.
Thus we have 
\begin{align}
  m_{S_t}(AC) &\le m_{S_t}(A) + \frac{c}{b+c}m_{S_t}(BC)\label{eqn:BCdiscounted}\\
  &= \frac{c}{b+c}m_{S_t}(ABC) + \frac{b}{b+c}m_{S_t}(A)\label{eqn:redistributeA}.
\end{align}

% {\color{red}
% where 
% \begin{equation}
%   \label{eqn:redistributeA}
%   &m_{S_t}(A) + \frac{c}{b+c}m_{S_t}(BC) \\
%   &= \frac{c}{b+c}m_{S_t}(ABC) + \frac{b}{b+c}m_{S_t}(A).
% \end{equation}
% Note that the expression in \eqref{eqn:redistributeA} is monotonically
% increasing in both $\mu_{S_t}(ABC)$ and $\mu_{S_t}(A)$. 
% Thus, by numerically replacing both average fills with
% their extremal values, $2n-|ABC|$ and $2n-|A|$, we can upper bound $m_{S_t}(AC)$ by,
% \begin{equation}
% \label{eq:numericallyinterpretit}
% m_{S_t}(AC) \le \frac{c}{b+c}(2n-|ABC|) + \frac{b}{b+c}(2n-|A|).
% \end{equation}

% At this point the claim can be verified by straightforward algebra,
% however this is not elegant; instead, we combinatorially interpret \eqref{eq:numericallyinterpretit}.

% We define a new ``fake" state $F$, which may not represent
% a valid configuration of cups (i.e. might not satisfy the invariants), where
% $\mu_F(A)=2n-|A|$ and $\mu_F(ABC)=2n-|ABC|$, in particular with all the cups in $A$
% having identical fill, and all the cups in $BC$ having identical fill. By construction, the right side of \eqref{eq:numericallyinterpretit} is,

% \begin{align}
%     &m_{F}(A) + c\mu_{F}(BC) \nonumber \\
%     &= \frac{b}{b+c} m_F(A) + \frac{c}{b+c} m_F(ABC) \label{eq:Fmotivation}\\
%     &= \frac{c}{b+c}(2n-|ABC|) + \frac{b}{b+c}(2n-|A|) \nonumber
% \end{align}
% Let us compare $F$ to the state $U$ in which every cup in $ABC$ has fill
% $\mu_F(ABC) = 2n-|ABC|$. To reach $F$ from this state $U$, we must increase the fill of each cup in $A$ by some amount, and
% decrease the fill of each cup in $BC$ by an amount such that the mass added to
% $A$ is taken away from $BC$. To reach fill $\mu_F(A) = 2n-|A|$, the cups in $A$
% must each have been increased by $|BC|$ from their previous fills of $2n-|ABC|$.
% To offset an increase in $\mu_{F}(A)$ of $|BC|$, we need a corresponding
% decrease in $\mu_{F}(BC)$ by $|A|$.
% Thus, by comparing states $F$ and $U$, we have concluded that, 
% \begin{equation}
%     \mu_{F}(BC) = 2n-|ABC|-|A|
%     \label{eq:BCispusheddown}
% \end{equation}
% Combining \eqref{eq:Fmotivation} and \eqref{eq:BCispusheddown}, we have that the right side of \eqref{eq:numericallyinterpretit} is
% \begin{align*}
% & m_{F}(A) + c(2n-|ABC|-|A|) \\
% &= a(2n-a) + c(2n-|ABC|-a) \\
% &= (a+c)(2n-a) - c(a+c+b) \\
% &= (a+c)(2n-a-c) - cb.
% \end{align*}
% }

Note that the expression in \eqref{eqn:redistributeA} is monotonically
increasing in both $\mu_{S_t}(ABC)$ and $\mu_{S_t}(A)$. Thus, by numerically
replacing both average fills with their extremal values, $2n-|ABC|$ and
$2n-|A|$. At this point the claim can be verified by straightforward (but quite
messy) algebra (and by combining
\eqref{eq:emptiereptiessomestufffillerfillssomestuff} with
\eqref{eqn:redistributeA}). We instead give a more intuitive argument, in which
we examine the right side of \eqref{eqn:BCdiscounted} combinatorially.

 Consider a new configuration of fills $F$ achieved by starting with state
 $S_t$, and moving water from $BC$ into $A$ until $\mu_{F}(A) = 2n-|A|$.
 \footnote{Note that whether or not $F$ satisfies the invariants is
 irrelevant.} This transformation increases (strictly increases if and only if
 we move a non-zero amount of water) the right side of
 \eqref{eqn:BCdiscounted}. In particular, if mass $\Delta \ge 0$ fill is moved
 from $BC$ to $A$, then the right side of \eqref{eqn:BCdiscounted} increases by
 $\frac{b}{b+c} \Delta \ge 0$. Note that the fact that moving water from $BC$
 into $A$ increases the right side of \eqref{eqn:BCdiscounted} formally
 captures the way the system of invariants being proven forces a tradeoff
 between the fill in $A$ and the fill in $BC$---that is, higher fill in $A$
 pushes down the fill that $BC$ (and consequently $C$) can have.

  Since $\mu_F(A)$ is above $\mu_{F}(ABC)$, the greater than average fill of
  $A$ must be counter-balanced by the lower than average fill of $BC$. In
  particular we must have
  $$(\mu_F(A) - \mu_F(ABC))|A| = (\mu_F(ABC) -\mu_F(BC))|BC|.$$
  Note that 
  \begin{align*}
  & \mu_F(A) -\mu_F(ABC) \\
  &= (2n-|A|) - \mu_F(ABC) \\
  &\ge (2n-|A|) - (2n-|ABC|) \\
  &= |BC|.    
  \end{align*}
  Hence we must have 
  $$\mu_F(ABC) - \mu_F(BC) \ge |A|.$$
  Thus 
  \begin{equation}
      \mu_F(BC) \le \mu_F(ABC) - |A| \le 2n-|ABC| -|A|.
      \label{eq:BCispusheddown}
  \end{equation}
  Combing \eqref{eqn:BCdiscounted} with the fact that the transformation from
  $S_t$ to $F$ only increases the right side of \eqref{eqn:BCdiscounted}, along
  with \eqref{eq:BCispusheddown}, we have the following bound:
  \begin{align}
    m_{S_t}(AC)
  &\le m_{F}(A) + c\mu_{F}(BC) \nonumber \\
  &\le a(2n-a) + c(2n-|ABC|-a) \nonumber \\
  &\le (a+c)(2n-a) - c(a+c+b) \nonumber \\
  &\le (a+c)(2n-a-c) - cb. \label{eq:eqnwithcb}
  \end{align}
  
By \eqref{eq:emptiereptiessomestufffillerfillssomestuff} and \eqref{eq:eqnwithcb}, we have that
\begin{align*}
    m_{S_{t+1}}(S_{t + 1}([k])) & \le m_{S_t}(AC) + b \\
                                & \le (a+c)(2n-a-c) - cb + b \\
                                & = k(2n-k) - cb + b \\
                                & \le k(2n-k),
\end{align*}
where the final inequality uses the fact that $c \ge 1$. This completes the proof of the claim. 
  
\end{proof}

We have shown the invariant holds for arbitrary $k$, so given that the
invariants all hold at state $S_t$ they also must all hold at state $S_{t+1}$.
Thus, by induction we have the invariant for all rounds $t\in\mathbb{N}$.
\end{proof}



\section{Oblivious Filler Lower Bound}\label{sec:oblivious}
We now prove a lower bound on backlog with an oblivious filler. First we
highlight the concentration inequalities that we will need in the analysis. 

The following theorem is known as Hoeffding's Inequality:
\begin{theorem}
  Let $X_i$ for $i=1,2,\ldots, k$ be independent bounded random variables with
  $X_i \in [a,b]$ for all $i$. Then,
  $$\Pr\left(\Big|\frac{1}{k} \sum_{i=1}^k (X_i - \E[X_i])\Big|\ge t\right) \le
  2\exp\left(-\frac{2kt^2}{(b-a)^2}\right) $$
\end{theorem}
There are also several useful corollaries of Hoeffding's Inequality. 
Firstly, the Chernoff Bound, i.e. Hoeffding's Inequality applied to binary
random variables, is a trivial corollary.
A more interesting corollary is that Hoeffding's Inequality applies to random
variables drawn without replacement from a finite population.
Let $S$ be a finite population, let $X_i$ for $i=1,2\ldots, k$ be chosen
uniformly at random from $S \setminus \{X_1,\ldots, X_{i-1}\}$, and let $Y_i$
for $i=1,2,\ldots, k$ be chosen uniformly at random from $S$.
Note that $\{X_1,\ldots, X_k\}$ represents a sample of $S$ chosen without
replacement, whereas $\{Y_1,\ldots, Y_k\}$ represents a sample with
replacement. Because the $Y_i$ are independent random variables
Hoeffding's Inequality provides a bound on the probability of $\sum_{i=1}^k
Y_i$ deviating from its mean by more than $t$.
The same bound can be given on the probability of $\sum_{i=1}^k X_i$ deviating
from its mean by more than $t$, because the probability of $\sum_{i=1}^k X_i$
deviating from its mean by more than $t$ is at most the probability of
$\sum_{i=1}^k Y_i$ deviating from it's mean by $t$.
Formally we can write this as 
\begin{corollary}
  \label{cor:hoeffdingwreplacement}
  Let $S$ be a finite set with $\min(S) \ge a, \max(S) \le b$, and let $X_i$
  for $i=1,2\ldots, k$ be chosen uniformly at random from $S \setminus
  \{X_1,\ldots, X_{i-1}\}$.
Then 
  $$\Pr\left(\Big|\frac{1}{k} \sum_{i=1}^k (X_i - \E[X_i])\Big|\ge t\right) \le
  2\exp\left(-\frac{2kt^2}{(b-a)^2}\right) $$
\end{corollary}
Hoeffding proved Corollary \ref{cor:hoeffdingwreplacement} in his seminal work
\cite{who62} (the result follows from his Theorem 4, combined with Hoeffding's
Inequality for independent random variables).
This result is intuitive as samples drawn without replacement should be more
tightly concentrated around the mean than samples drawn with replacement, which
are more free to vary.

We now proceed with our analysis of oblivious lower bounds.

Call a cup configuration $M$\defn{-flat} if the fill of every cup is in the
interval $[-M, M]$. Call an emptier $\Delta$\defn{-greedy-like} if whenever
there are two cups $c_1, c_2$ satisfying $\fil(c_1) > \fil(c_2) +
\Delta$ the emptier never empties from $c_2$ without emptying from $c_1$ on the
same round. Intuitively, a $\Delta$-greedy-like emptier has a $\pm \Delta$
range where it is allowed to ``not be greedy". Note that a perfectly greedy
emptier is $0$-greedy-like. We call an emptier \defn{greedy-like} if it is
$\Delta$-greedy-like for $\Delta \le O(1)$.
In the randomized setting we are only able to prove lower bounds for backlog
against greedy-like emptiers; whether or not our results can be extended to a
more general class of emptiers is an interesting open question. 
Nonetheless, greedy-like emptiers are of great interest; for example, a greedy
emptier is used in the upper bound proof.  

We now prove a crucial property of greedy-like emptiers: 
\begin{proposition}
  \label{prop:greedylikeisflat}
  Given a cup configuration that is $M$-flat, an oblivious filler can achieve a
  $2(2+\Delta)$-flat configuration of cups against a $\Delta$-greedy-like
  emptier in running time $2M$ in the negative-fill variable-processor cup
  game on $n$ cups.
\end{proposition}
\begin{proof}
  The filler sets $p=n/2$ and distributes fill equally amongst
  all cups at every round, in particular placing $1/2$ fill in each cup.
  Let $\ell_t = \min_{c\in S_t} \fil_{S_t}(c)$, $u_t=\max_{c\in S_t} \fil_{S_t}(c)$. Let
  $L_t$ be the set of cups $c$ with $\fil_{S_t}(c) \le l_t+2+\Delta$, and let
  $U_t$ be the set of cups $c$ with $\fil_{S_t}(c) \ge u_t-2-\Delta$.

  There are two ways to think of $U_t$. First, $U_t$ contains cups in the union
  of intervals of length $1$, $\Delta$, and $1$. This ensures that if any cup
  with fill in $[u_t-\Delta-2, u_t-\Delta-1]$ is emptied from then all cups
  with fills in $[u_t-1, u_t]$ must be emptied from because the emptier is
  $\Delta$-greedy-like. Second, $U_t$ contains cups with fill in the union of
  $[u_t-2, u_t]$ and $[u_t-\Delta-2, u_t-2]$. Thus if there are more than $n/2$
  cups outside of $U_t$ then all cups in $[u_t-2, u_t]$ must be emptied from
  because the emptier is $\Delta$-greedy-like. $L_t$ is of course completely
  symmetric to $U_t$.

  Now we prove a key property of the sets $U_t$ and $L_t$: once a cup is in
  $U_t$ or $L_t$ it is always in $U_{t'}, L_{t'}$ for all $t' > t$. This
  follows immediately from the following claim:
  \begin{clm}
    \label{clm:dontlosestuff}
    $$U_{t} \subseteq U_{t+1}, L_t \subseteq L_{t+1}.$$
  \end{clm}
  \begin{proof}
    Consider a cup $c\in U_t$.

    If $c$ is not emptied from, i.e. $\fil(c)$ has increased by $1/2$, then
    clearly $c \in U_{t+1}$, because backlog has increased by at most $1/2$, so
    the fill of $c$ must still be within $2+\Delta$ of the backlog on round $t+1$. 

    On the other hand, if $c$ is emptied from, i.e. $\fil(c)$ has decreased by
    $1/2$, we consider two cases.\\
    \textbf{Case 1:} If $\fil_{S_t}(c) \ge u_t-\Delta -1$, then $\fil_{S_t}(c)$
    is at least $1$ above the bottom of the interval. The backlog increases by
    at most $1/2$ and the fill of $c$ decreases by $1/2$, so
    $\fil_{S_{t+1}}(c)$ is at least $1-1/2-1/2 = 0$ above the bottom of the
    interval, i.e. still in the interval. \\
    % We can also express this in terms
    % of equations: $u_{t+1} \le u_t+1/2$, so
    %   $$\fil_{S_{t+1}}(c) \ge u_t-\Delta-1 - 1/2\ge u_{t+1}-\Delta-2.$$
    \textbf{Case 2:} On the other hand, if $\fil_{S_t}(c) < u_t-\Delta-1$, then every cup
        with fill in $[u_t-1, u_t]$ must have been emptied
        from. The fullest cup at round $t+1$ is the same as the fullest cup on
        round $t$, because the fills of all cups with fill in
        $[u_t-1, u_t]$ have decreased by $1/2$, and no cup with fill less than
        $u_t-1$ had fill increase by more than $1/2$. Hence $u_{t+1} = u_t -1/2$.
        Because both the fill of $c$ and the backlog have decreased by the same
        amount, the distance between them is still at most $\Delta+2$, hence
        $c\in U_{t+1}$.\\
    The argument for $L_t \subseteq L_{t+1}$ is symmetric.
  \end{proof}

  Now that we have shown that $L_t$ and $U_t$ never lose cups, we will show
  that they each eventually gain more than $n/2$ cups:

  \begin{clm}
    \label{clm:smallthenbigger}
    As long as $|U_t| \le n/2$ we have $u_{t+1} = u_t -1/2$. Identically, as
    long as $|L_t| \le n/2$ we have $\ell_{t+1} = \ell_t+ 1/2$.
  \end{clm}
  \begin{proof}
    If there are more than $n/2$ cups outside of $U_t$ then there must be some
    cup with fill less than $u_t-\Delta-2$ that is emptied from. Because the
    emptier is $\Delta$-greedy-like this means that the emptier must empty from
    every cup with fill at least $u_t-2$. Thus $u_{t+1} = u_t -1/2$: no cup
    with fill less than $u_t-2$ could have become the fullest cup, and the
    previous fullest cup has lost $1/2$ units of fill. 

    The proof is symmetric for $L_t$.
  \end{proof}

  By Claim \ref{clm:smallthenbigger} we see that both $|U_t|$ and $|L_t|$ must
  eventually exceed $n/2$ at some times $t_u, t_\ell \le 2M$, by the assumption
  that the initial configuration is $M$-flat. Since by Claim
  \ref{clm:dontlosestuff} $|U_{t+1}|\ge |U_t|$ and $|L_{t+1}| \ge |L_t|$ we
  have that there is some round $t_0 =\max(t_u, t_\ell) \le 2M$ on which both
  $|U_{t_0}|$ and $|L_{t_0}|$ exceed $n/2$. Then $U_{t_0} \cap L_{t_0} \neq
  \varnothing$. Furthermore, the sets must intersect for all $t_0 \le t \le 2M$. 
  In order for the sets to intersect it must be that the intervals
  $[u_t-2-\Delta, u_t]$ and $[\ell_t, \ell_t+2+\Delta]$ intersect. Hence we have that 
  $$\ell_t+2+\Delta \ge u_t-2-\Delta.$$ Since $u_t \ge 0$ and $\ell_t \le 0$
  this implies that all cups have fill in $[-2(2+\Delta), 2(2+\Delta)]$.

\end{proof}

Given a $\Delta$-greedy-like filler, let $R_\Delta = \lceil 2(2+\Delta)
\rceil.$ \footnote{It is convenient to have this be an integer, and there is no
drawback to taking a slightly larger $R_\Delta$ than necessary. In fact, this
value of $R_\Delta$ is already not tight.}
By Proposition \ref{prop:greedylikeisflat}, if a filler is given a $M$-flat
configuration of cups they can achieve a $R_\Delta$-flat configuration of cups.

Now we are equipped to prove the following proposition:
\begin{proposition}
  \label{prop:obliviousBase}
  Let $H \le O(1)$, $M \le \poly(n)$, $\Delta \le O(1)$, $n \ge \Omega(1)$ at
  least a sufficiently large constant. 

  There exists an oblivious filling strategy for the negative-fill
  variable-processor cup game on $n$ cups that achieves backlog $H$ on a
  $M$-flat configuration of cups in running time $\poly(n)$ against a
  $\Delta$-greedy-like emptier with probability at least $1-2^{-\Omega(n)}.$
\end{proposition}
\begin{proof}
  The filler starts by flattening the cups, using the flattening procedure
  detailed in Proposition \ref{prop:greedylikeisflat}. 

  Let $A$, the \defn{anchor} set, be an arbitrary (e.g. randomly chosen) subset
  of $n/32$ cups and let $B$, the \defn{non-anchor} set, consist of the rest of
  the cups ($|B| = n\cdot 31/32$). Let $h = 16\Delta + 16$, and let $h' = 2$. Note that
  the average fill of $A$ and $B$ both must start as at least $-R_\Delta$ due
  to the flattening.

  The filler sets $p=|A|+1$. The filler's strategy is roughly as follows: \\
  \textbf{Step 1:} Make a constant fraction of the cups in $A$ have fill at
  least $h$ by playing single processor cup games on constant-size subsets of
  $B$ and then swapping the cup within $B$ that has high fill, with constant
  probability, into $A$. By a Chernoff bound this makes a constant fraction of
  $A$, say $nc$ cups, have fill at least $h$ with exponentially good
  probability. Between single-processor cup games the filler flattens $B$.\\
  \textbf{Step 2:} Reduce the number of processors to $nc$, and raise the fill
  of $nc$ \emph{known} cups to fill $h'$. The emptier must first empty from the
  cups with fill $h$ before emptying from the cups that the filler is
  attempting to get fill $h'$ in.\\
  \textbf{Step 3:} Recurse on the $nc$ cups that are known to have fill at
  least $h'$.

To achieve Step 1 the filler performs a series of $|A|$ \defn{swapping-process},
which are procedures that the filler uses to get a new cup --hopefully with
high fill-- in $A$. A swapping-process is composed of a substructure, repeated
many times, which we call a \defn{round-block}; a round-block is a set of
rounds. A swapping-process will consists of $|A|\cdot c_\Delta$ round-blocks
($c_\Delta = \Theta(1)$ a function of $\Delta$ to be specified); at the beginning
of each swapping-process the filler chooses a round-block $j$ uniformly at
random from $[|A|\cdot c_\Delta]$. 

For each round-block $i\in [|A|\cdot c_\Delta]$, the filler selects a random subset
$D_i\subset B$ of the non-anchor cups and plays a single processor cup game on
$D_i$. In this single-processor cup game the filler essentially employs the
classic adaptive strategy for achieving backlog $\Omega(\log |B|)$ on a set of
$|B|$ cups, with slight modifications for the fact that it is oblivious. In
particular, the filler will only achieve this fill with constant probability.
While doing this, the filler always places $1$ unit of fill in each cup in the
anchor set. 

At the end of each round-block the filler applies the flattening procedure to
flatten the non-anchor set. Note that this will not affect the running time beyond a
multiplicative factor (of e.g. $3$). 

On most round-blocks -- all but the $j$-th -- the filler does nothing with the
cup that it achieves with constant probability in its single processor cup
game. However, on the $j$-th round-block the filler swaps the ``winner" of the
single processor cup game into the anchor set (with constant probability there
is a winner).

Now we formally prove that the Step 1 succeeds (with exponentially good probability).

\begin{clm} \label{clm:reg} 
  With probability at least $1-2^{-\Omega(n)}$, the filler achieves fill
  at least $h$ in at least $nc = \Theta(n)$ of the cups in $A$. 
\end{clm}
\begin{proof}
  Consider a particular swapping-process. Let $j$, the round-block on which the
  filler will perform the swap, be chosen uniformly randomly from $[|A|\cdot
  c_\Delta]$ ($c_\Delta$ to be determined).
 
  Say the emptier \defn{neglects} the anchor set during a round-block if on at
  least one round of the round-block the emptier does not empty from every cup
  in the anchor set. By playing the single-processor cup game for many
  round-blocks with only one round-block when the filler actually swaps a cup
  into the anchor set, the filler prevents the emptier from neglecting the
  anchor set too often.

  On each round-block the filler chooses a random subset $D_i \subset B$ of
  $\lceil e^{2h} \rceil$ cups. If the emptier does not neglect the anchor set
  on round-block $i$ then the filler plays a legitimate single-processor cup
  game on $n$ cups. The filler maintains an \defn{active-set} of cups, which is
  a subset of $D_i$ initialized to $D_i$. On each round of the round-block the
  filler distributes $1$ unit of fill equally among all cups in the active set.
  Then the emptier removes fill from some cup in $B$. The filler chooses a
  random cup to remove from the active set. The probability that the cup the
  emptier emptied from is not in the active set after a random cup is removed
  from the active set by the filler is at least constant. By the end of the
  round-block the active-set will consist of a single cup. With constant
  probability, in particular probability at least $$q_0 = 1/\lceil e^{2h}
  \rceil!$$ this cup has gained fill at least $\ln \lceil e^{2h} \rceil \ge
  2h$. 

  Consider what this cups fill started as at the beginning of the round-block.
  By the flattening it was within $\pm \Delta$ of $\mu(B)$. However, $\mu(B)\ge
  -R_\Delta$ isn't necessarily true; although before any swapping-process were
  performed the entire set of cups was $R_\Delta$ flat, the filler is moving
  cups from $B$ --hopefully with high fill-- into $A$ which could cause the
  average fill of $B$ to sink. However, it cannot have sunk very much. At most,
  if every swapping process succeeds, we would still have less than, say, $|A|
  \cdot 4h$ mass removed from $B$. Thus the average fill of $B$ is certainly
  never less than
  \begin{equation}
    \label{eq:Bisntsobad}
    \ell_b = -R_\Delta - \frac{|A|}{|B|} 4h = -R_\Delta - \frac{1}{31}4h\ge -h/2.
  \end{equation}
  Thus, a cup with fill that has increased by at least $2h$ from
  the start of the round-block has fill at least $h$.

  It is also useful to know how high $\mu(B)$ could possible rise, which will
  help us bound how far $\mu(A)$ could possibly sink. A cup removed from $B$
  has fill strictly more than $s = -h-R_\Delta-\lceil e^{2h} \rceil$. The
  fills of cups in $A$ have fill no more than $R_\Delta$ initially. 
  Hence $\mu(B)$ can certainly rise no higher than
  $u_b = \frac{|A|}{|B|}(f_b+R_\Delta)+R_\Delta$.
  It is conceivable that $\mu(A)$ could sink during this process. In
  particular, the cup swapped into $A$ from $B$ might have quite negative fill:
  if the emptier emptied from it on each round of the round-block 
  the cups fill would have decreased by strictly less than $\lceil e^{2h} \rceil.$ As
  $\mu(B)$ never drops below $-h$ and $B$ starts each single-processor cup game
  $R_\Delta$-flat, we have that any cup swapped into $A$ has fill at least $s$.
   We thus have (the quite loose) lower bound that $\mu(A)$ can certainly never
   drop below $\ell_a = s-R_\Delta$.

  Now we shall choose $c_\Delta$, choosing it large enough such that with
  constant probability there is some round-block on which the emptier doesn't
  neglect the anchor set on which the filler succeeds.

  Let $\mu_0 = -\ell_a+\mu_b+R_\Delta+\Delta$. The emptier can neglect the anchor set no
  more than $|A|\mu_0$ times, because it is $\Delta$-greedy-like and neglecting
  the anchor set $|A|$ times would increase the mass of the anchor set by
  $\mu_0$, and consequently make each cup in $A$ have fill high enough that the
  emptier, being $\Delta$-greedy-like would be forced to empty from that cup; in
  particular, a cup in $A$ starts with fill at least $\ell_a$, so after having fill
  increased by $\mu_0$ such a cup with have fill at least $R_\Delta+\Delta$ than
  $\mu_b$ (the maximum average fill of $B$). Hence such a cup must be emptied from.

  We choose $$c_\Delta = 2\frac{1}{q_0}\mu_0.$$ By having $|A|\cdot c_\Delta$
  round-blocks, we make it so that there should be at least $|A|\mu_0$
  round-blocks on which the filler correctly guesses the emptier's emptying
  sequence. Formally this is due to a Chernoff bound: the expectation of the
  number of rounds when the filler correctly guesses the emptier's emptying
  sequence is at least $2|A|\mu_0$, and the probability that it deviates from
  its expectation by more than $|A|\mu_0$ is hence exponentially small in $|A|$
  and hence $n$ as $|A| =\Theta(n)$. As shown before, the emptier cannot
  neglect the anchor set more than $|A|\mu_0$ times. The filler correctly
  guesses the emptiers emptying sequence on the $j$-th round-block. Conditioned
  on this event, the $j$ is chosen uniformly randomly from all the round-blocks
  on which the filler correctly guesses the emptiers emptying sequence. Since
  the emptier can neglect the anchor set on at most half of these round-blocks
  there is at least a $1/2$ chance that $j$ is chosen on a round-block where
  the filler does not neglect the anchor set. Thus, overall, there is at least
  a constant probability of achieving fill $h$ in a cup in $A$.

  Say that a swapping-process \defn{succeeds} if the filler is able to swap a
  cup with fill at least $h$ into $A$. We have shown that there is a constant
  probability of a given swapping-process succeeding. Let $X_i$ be the binary
  random variable indicating whether or not the $i$-th swapping process
  succeeds. Let $q \ge \Omega(1)$ be the probability of a swapping-process
  succeeding, i.e. $\Pr(X_i=1)$. Note that the random variables $X_i$ are clearly
  independent, and identically distributed.

  Clearly $$\E\left[\sum_{i=1}^{n/4} X_i\right] = qn/4.$$ 
  By a Chernoff Bound (i.e. Hoeffding's Inequality applied to binary random variables),
  $$\Pr\left(\sum_{i=1}^{n/4} X_i\le nq/8\right) \le e^{-nq^2/128}.$$ That is, the
  probability that less than $nq/8$ of the anchor cups have fill at least $h$ is
  exponentially small in $n$, as desired.

\end{proof}

Hence Step 1 is possible.

Step 2 is easily achieved by setting $p=nc$ and uniformly distributing the
fillers fill among a chosen set $S$ of $nc$ cups, $S\subset B$ chosen
arbitrarily. The greedy nature of the emptier will force it to focus on the
cups which must exist in $A$ with large positive fill until the cups in $S$
have sufficiently high fill. In particular, the fills of the cups in $S$ must
start as at least $\ell_b \ge -h/2$ by \eqref{eq:Bisntsobad}.
After removing from the very full cups for $\lceil h/2+h' \rceil$ rounds the
fills of these new cups are clearly at least $h'$. Note that throughout this
process the emptier cannot have emptied from the cups in $S$ until they
attained fill $h'$ because there would be $p=nc$ cups at least $\lceil h/2+h'
\rceil \ge h' + \Delta$ by design in choice of $h$.

Step 3, which is to recurse, is of course possible. 
By performing $H\le O(1)$ levels of recursion, increasing the fill by $h' = 2$ and
reducing the problem size by a factor of $c$ at each
level of recursion, the filler achieves backlog at least $2H$. 
Say the probability of Step 1 succeeding is at least
$1-e^{-nk}$. Then (by the union bound) the probability that any of $H$ levels of
recursion fail is bounded above by 
$$e^{-nk} + e^{-nck} + e^{-nc^2 k} + \cdots + e^{-nc^H k} \le 2^{-\Omega(n)}.$$
Hence the probability that every level of recursion succeeds is at least $1-2^{-\Omega(n)}$.

\end{proof}

\begin{lemma}[Oblivious Amplification Lemma]
  \label{lem:obliviousAmplification} 
  Let $\Delta \le O(1)$, $M, M' \ge R_\Delta$, $q \ge \Omega(1)$, $f$ be an
  oblivious filling strategy that achieves backlog $f(n)$ in the negative-fill
  variable-processor cup game on $n$ cups with probability at least $1-2^{-qn}$
  in running time $T(n) \le \poly(n)$ when given a $M$-flat configuration,
  against a $\Delta$-greedy-like emptier.

  Let $0< \delta \ll 1/2$, $L\in \mathbb{N}$, $\eta \in \mathbb{N}$ be constant
  parameters, appropriately chosen. Let $1/2 \ll \phi<1$ be a constant
  parameter chosen as close to $1$ as desired. 

  There exists an oblivious filling strategy that achieves backlog $$f'(n) \ge
  \phi \cdot (1-\delta)\sum_{\ell=0}^L f((1-\delta)\delta^\ell n)$$ in the
  negative-fill variable-processor cup game on $n$ cups given a $M'$-flat configuration of
  cups in running time $$T'(n) \le O(M') + (\delta L) n^{\eta+1}
  T((1-\delta)n)$$ against a $\Delta$-greedy-like emptier with probability at
  least $$1-2^{-\Omega(n)}.$$
\end{lemma}
\begin{proof}
  The proof is quite similar to the proof of Lemma
  \ref{lem:adaptiveAmplification}, but more complicated because the filler's
  strategy must be randomized.

  The filler starts by flattening all the cups, using the flattening procedure
  detailed in Proposition \ref{prop:greedylikeisflat}. 

  Let $A$, the \defn{anchor} set, be a subset of the cups chosen uniformly at
  random from all subsets of size $n\delta$ of the cups, and let $B$, the
  \defn{non-anchor} set, consist of the rest of the cups ($|B| = n(1-\delta)$).
  Let $n_\ell = n\delta^{\ell-1}, h_\ell = (1-\delta)f(n_\ell(1-\delta))$; the
  filler will achieve average fill $h_\ell$ on a set of $n_\ell\delta$ cups on
  the $\ell$-th level of its recursive process. Note that the average fill of
  $A$ and $B$ both must start as at least $-R_\Delta$ due to the flattening.

  The filler's strategy is essentially as follows:\\
  \textbf{Step 1:} Using $f$ repeatedly, achieve fill
  $(1-\delta)f(n(1-\delta))$ in cups in the non-anchor set and then swap these
  cups into the anchor set.  \\
  \textbf{Step 2:} Decrease the number of processors to $p=\delta n$ and
  recurse on the anchor set.

  First we show how to achieve Step 1. 
  The filler's strategy will be to always place $1$ fill in each cup in the
  anchor-set while applying $f$ to $B$.
  As always, the filler cannot directly apply $f$ to $B$; the filler must ensure that
  the emptier is using the appropriate amount of resources on $B$.

  For each cup in $A$ the filler performs a procedure called a
  \defn{swapping-process}, which consists of a sub-structure repeated many
  times that we call a \defn{round-block}. Each round-block consists of an
  \defn{attempt} to apply $f$. We say that the emptier \defn{neglects} the
  anchor set on a round-block if there is at least $1$ round on which the
  emptier does not empty from each cup in the anchor set. The mass of the
  anchor set increases by at least $1$ on each round-block that the anchor set
  is neglected. This cannot happen more than $n\delta(2R_\Delta + \Delta) =
  n\delta\mu_\Delta$ times. Thus, by making each swapping-process consist of
  $n^{\eta}$ round-blocks (note: we do $n^{\eta}$ round-blocks on all levels of
  recursion, everything else changes to $n_\ell$ but not this) and then
  choosing a single round-block
  among these (uniformly at random) to swap a cup in to $A$, we guarantee that
  with probability at least $\delta\mu_\Delta/n^\eta$ this round-block occurs
  on a round-block when the emptier
  does not neglect the anchor set. On this round-block $f$ is legitimately
  applied, and succeeds with probability at least $1-2^{-qn}$ . At the end of
  each round-block the filler flattens $B$, so that $f$ is receiving as input a
  flattened set of cups as needed. Over the course of this process the average
  fill of $B$ will decrease a little. In the most extreme case $f$ may have
  succeeded up to $\delta n$ times, in which case the mass transfered from $B$
  to $A$ would be $\delta n f((1-\delta) n)$. In order for their to be an
  increase in the difference of the average fills of $A$ and $B$ by this amount
  $B$ would have had to contribute $|A|/n = \delta$ of the difference, with $A$
  contributing $|B|/n=(1-\delta)$ of the difference. Hence the average fill of
  $A$ would have actually only increased by $(1-\delta) f((1-\delta)n)$.
  {\color{red} the whole preceding part is a little bit sketchy.}

  For Step 2 the filler simply recurses. 
  The run-time bound is clear: The initial smoothing takes time $O(M')$, and
  after that, at each level of recursion for each cup in the anchor set the
  filler applies $f$ to the non-anchor set $n^\eta$ times. Hence the running
  time due to this is 
  $$\sum_{\ell=0}^L (\delta^\ell n\delta) n^\eta T((1-\delta)\delta^\ell n).$$
  This is quite complicated, a simpler bound suffices; bounding each term in
  the sum with the first term, which is clearly the largest, we have
  $$T'(n) \le O(M') + (L\delta)n^{\eta+1} T((1-\delta)n).$$

  It is almost clear that the desired backlog is achieved; if every swapping
  process succeeded then we would achieve fill $(1-\delta)
  f((1-\delta)\delta^\ell n)$ in each cup in the anchor set at each level of
  recursion hence achieving backlog $$(1-\delta)\sum_{\ell=0}^L
  f((1-\delta)\delta^\ell n)$$ overall. However each swapping process has some
  (very small) probability of failing; we computed probability of failure this
  to be at most $\delta \mu_\Delta / n^\eta.$ Consider the probability that
  more than a constant fraction $w = \Theta(1)$ of the $s = \sum_{\ell=0}^L
  n\delta^{\ell+1}$ swapping-processes fail. Let $X_i$ be the random variable
  indicating whether the $i$-th swapping-process succeeds (note: this is
  swapping-processes on all levels of recursion), and let $X=\sum_{i=1}^s X_i$.
  Clearly $\E[X] = s(1-\delta\mu_\Delta/n^\eta)$. Success of the
  swapping-processes are not independent events: a swapping-process is in-fact
  more likely to succeed given that previous swapping-processes have failed.
  Hence we can upper bound the probability of more than a $w$-fraction of the
  swapping-processes failing by a Chernoff Bound: $$\Pr\left(\frac{1}{s}X \ge
  \frac{1}{s}\E[X] - w/2\right) \ge 1-2e^{-s w^2/2} \ge 1-2^{\Omega(n)}$$ By
  appropriately large choice for $\eta \le O(1)$, $$\delta\mu_\Delta /n^\eta
  \le w/2$$ no matter how small $w \ge \Omega(1)$ is chosen. In particular this
  implies that $\Pr[X \ge s(1-w)] \ge 1-2^{\Omega(n)}$.

  Now we will define $\phi$ such that success of $s(1-w)$ of the
  swapping-processes guarantees backlog $$\phi \cdot (1-\delta) \sum_{\ell=0}^L
  f(n(1-\delta)\delta^\ell).$$ In the worst case the failed swapping-processes
  bring very negative cups into the anchor-set, potentially as negative as
  $-\delta f((1-\delta)\delta^\ell n)$ on the $\ell$-th level of recursion.
  However, clearly this is equivalent to removing at most $2$ cups worth of
  mass from the anchor set. Overall we thus remove at most $2w$ cups worth of
  mass from the anchor set. Hence choosing $\phi = 1-2w$ works.
  Noting that the constant $w > 0$ was arbitrary we have that $\phi$ can be
  made any constant arbitrarily close to $1$.

  In order to achieve this backlog however, not only does the filler need to be
  able to swap over $s(1-w)$ cups on rounds where the emptier neglects the
  anchor set, but no applications of $f$ can fail; failure happens with
  probability $2^{-n(1-\delta)\delta^\ell q}$ for an application of $f$ to
  $n(1-\delta)\delta^\ell$ cups. Taking a union bound over the $\poly(n)$
  applications of $f$ clearly still gets probability failure at most
  $2^{-\Omega(n)}$.

  Thus overall the filler succeeds with at least probability $1-2^{-\Omega(n)}$.

\end{proof}

\begin{theorem}
  \label{thm:obliviousPoly}
  There is an oblivious filling strategy for the variable-processor cup game on
  $n$ cups that achieves backlog at least $\Omega(n^{1-\epsilon})$ for any
  constant $\epsilon >0$ in running time $2^{O(\log^2 n)}$ with probability at least $1-2^{-\Omega(n)}$.
\end{theorem}
\begin{proof}
  The proof is quite similar to that of Theorem \ref{thm:adaptivePoly},
  except we do not achieve the extremal backlog $\Omega(n)$ due to its
  extremely long running time being so long as to make our probabilities not
  good enough. Nonetheless it is quite remarkable that the filler is still able to 
  achieve $\poly(n)$ backlog, and in fact the same asymptotic backlog as the
  adaptive filler when the games are restricted to the reasonable length of
  $2^{O(\log^2 n)}$. Because of the similarity to Theorem's
  \ref{thm:adaptivePoly} proof, we ignore minor technical details in this
  section, specifically with regards to there being an integer number of cups.
  These can be dealt just as in the proof of Theorem \ref{thm:adaptivePoly}: by
  modifying $n$ and $\delta$ slightly to be powers of $2$.

  We aim to achieve backlog $cn^{1-\epsilon}$ for $\epsilon >  0$ a constant of
  our choice, and $0< c \ll 1$ an appropriate constant that we will choose.
  As in the proof of Theorem \ref{thm:adaptivePoly} we achieve large backlog
  by repeated amplification of a base case. 

  The base case is given by Proposition \ref{prop:obliviousBase}. However,
  unlike in the adaptive case, we cannot do the base case on a constant size
  subset of the cups: this would destroy our probability of success. Recalling
  that the running time of the algorithm is going to be $2^{\polylog(n)}$ it
  seems reasonable to want to union bound over $2^{\polylog(n)}$ events. Hence
  the probability of failure needs to also be at most $2^{-\polylog(n)}$.
  Hence as our base case we use a $\polylog(n)$ size subset of the cups. 
  Let $n_b = \polylog(n)$ be the size of our base case.

  Our base case strategy is 
  $$
  f_0(k)=
  \begin{cases}
    2, & k > n_b\\
    0, & k \le n_b
  \end{cases}.$$
  This is possible by Proposition \ref{prop:obliviousBase}.
  Then we construct $f_{i+1}$ as the amplification of $f_i$ using Lemma \ref{lem:obliviousAmplification}.

  Define $g_i$ as 
  $$
  g_i =
  \begin{cases}
    1/\delta, & i=0\\
    g_{i-1}/(1-\delta), & i\ge 1 
  \end{cases}.$$

  \begin{clm}
    \label{clm:fikinductionagain}
    $f_i(k \cdot n_b) \ge ck^{1-\epsilon}$ for all $k < g_i$.
  \end{clm}
  We prove Claim \ref{clm:fikinductionagain} by induction. Clearly by
  appropriate choice of $c$ the base case is satisfied.

  Assume the claim for $f_i$, consider $f_{i+1}$. For any $k < g_{i-1}/(1-\delta)$ we have
  \begin{align*}
    f_{i+1}(k\cdot n_b) & \\
                  &\ge \phi\cdot(1-\delta)\sum_{\ell=0}^L f_i((1-\delta)\delta^\ell k\cdot n_b)\\
                  &\ge \phi\cdot(1-\delta)\sum_{\ell=0}^L c ((1-\delta)\delta^\ell k)^{1-\epsilon}\\
                  &\ge ck^{1-\epsilon} \phi\cdot(1-\delta)^{2-\epsilon}\sum_{\ell=0}^L (\delta^\ell)^{1-\epsilon}\\
                  &\ge ck^{1-\epsilon} \phi\cdot(1-\delta)^{2-\epsilon}( 1+\delta^{1-\epsilon}).
  \end{align*}

  Now we must prove the following claim, which is nearly identical to Claim
  \ref{clm:validchoices}, but slightly complicated by the $\phi$ factor out front:
  \begin{clm}
    Let 
    $$h(\delta, \phi) = \phi\cdot (1-\delta)^{2-\epsilon}(1+\delta^{1-\epsilon})$$
    There exists constant choices of $\delta, \phi$ such that $h(\delta, \phi) > 1$.
  \end{clm}
  \begin{proof}
    As before we lower bound $h$ by 
    $$h(\delta, \phi) \ge \phi \cdot (1-(2-\epsilon)\delta)(1+\delta^{1-\epsilon}).$$
    Recall from before that 
    $$(1-(2-\epsilon)\delta)(1+\delta^{1-\epsilon}) -1$$ is positive for
    $\delta \in (0, 1/(2(2-\epsilon))^{1/\epsilon})$. Choosing $\delta$ as the
    midpoint of this interval, $(1-(2-\epsilon)\delta)(1+\delta^{1-\epsilon})$
    is some value strictly larger than $1$, say $1+z$. Then
    choosing $$\phi = \frac{1+z/2}{1+z}$$
    guarantees that $h(\delta, \phi) = 1+z/2 > 1$ as desired.
  \end{proof}

  Now we can complete the proof of Claim \ref{clm:fikinductionagain}, 
  \begin{align*}
    f_{i+1}(k) & \\
               &\ge ck^{1-\epsilon} h(\delta, \phi)\\
               &\ge ck^{1-\epsilon}.
  \end{align*}

  Recursing for $O(\log n)$ levels of recursion is sufficient to achieve a function $f$ with 
  $$f(n) \ge c(n/n_b)^{1-\epsilon}$$
  As $n_b \le \polylog(n)$ this is still $\Omega(n^{1-\epsilon})$ as desired.

  Hence the desired backlog is achieved. See the proof of Theorem
  \ref{thm:adaptivePoly} for how to treat the integers more carefully.

  By identical analysis to before we get running time $2^{O(\log^2 n)}$.
  As stated previously, the probability result is guaranteed by a union bound,
  so we have probability at least $1-2^{-\polylog(n)}$ of success.
\end{proof}

% this probably belongs somewhere in the corollary proof, which will be
% substantially more complex than I originally anticipated, because Prop and
% Lemma need to take as input cups arrangements with flatness guarantees
% \begin{clm}
%   Without loss of generality the cup state is always $(h\sqrt{n/\lg\lg n})$-flat.
% \end{clm}
% \begin{proof}
% In order to flatten a set of cups we must have a bound on the magnitude of the
% fills of the cups. We claim that without loss of generality no cup has fill
% larger in magnitude than $h\sqrt{n/\log\log n}$. If a cup has more than
% $h\sqrt{n/\log\log n}$ fill we call the cup \defn{overpowered}. If there ever
% is an overpowered cup then we are automatically done: the emptier has achieved
% $\poly(n)$ backlog and will maintain it for at least $\poly(n)$ rounds. If a
% cup ever has fill less than $-h\sqrt{n/\log\log n}$ then the absolute average
% fill must be large enough such that the absolute fill of this cup is at least
% $0$. Thus there is an overpowered cup. From now on we assume that there are no
% overpowered cups.
% \end{proof}

% \begin{proposition}
%   \label{prop:obliviousBase}
%   There exists an oblivious filling strategy in the variable-processor cup game
%   on $n$ cups that achieves backlog $\Omega(\log n)$ against a $(T,
%   \Delta)$-greedy-like emptier (where $T, \Delta \le O(1)$ are constants
%   known to the filler), with constant probability.
% \end{proposition}
% \begin{proof}
%   Let $A$, the \defn{anchor} set, be a subset of the cups chosen uniformly at
%   random from all subsets of size $n/2$ of the cups, and let $B$, the
%   \defn{non-anchor} set, consist of the rest of the cups ($|B| = n/2$). Let $h
%   = 2 T + 4$. After attaining average positive tilt at least $h$ in a constant
%   fraction of $A$, exploiting the fact that the emptier is greedy-like, the
%   filler can use this positive tilt to create a known set of cups each with
%   fill at least $h' = 1$. More specifically, the filling algorithm proceeds as
%   follows: 
%   \begin{itemize}
%     \item \textbf{Step 1:} 
%       Obtain large positive tilt in $A$. If at least half of the cups $c\in B$
%       have $\fil(c) \ge -384h$, then we can, with constant probability, achieve
%       a cup with fill $h$ in $B$ -- which we will then swap to $A$ -- by
%       playing a single-processor cup game on a constant-size ($\lceil e^{385h}
%       \rceil$ suffices) subset of $B$. 
%       On the other hand, if at least half of the cups in $B$ have fill less than
%       $-384h$, then the expectation of the positive tilt of a cup chosen
%       randomly is high; this property can be exploited to get high positive
%       tilt in the anchor set.

%       Because the filler is oblivious it cannot know which of these states it is in; 
%       thus the filler employs a hybrid of these strategies, switching between
%       them with certain probabilities, which works in both cases.
%   \item \textbf{Step 2:} Reduce the number of processors to a constant fraction
%     $c$ of $n$, where $c$ is chosen such that there must be a set of at most $nc$ unknown cups $S$ with 
%     $$\sum_{x\in S} \lfloor \tilt(x) / h \rfloor \ge nc.$$
%     Using this positive tilt, the filler can raise the fill of $nc$ known cups
%     to $h'$, because the emptier is greedy.
%   \item \textbf{Step 3:} Recurse on the $nc$ cups that are known to have fill
%     at least $h'$.
% \end{itemize}
% By performing $\Omega(\log n)$ levels of recursion, achieving constant backlog
% $h'\ge 1/2$ at each step (relative to the average fills), the filler achieves backlog
% $\Omega(\log n)$.

% The strategy as stated fails if fill is extremely concentrated in a very small
% number of cups; however, in this case the proposition is trivially satisfied.
% In particular, we call a cup \defn{overpowered} if it contains fill at least
% $h\sqrt{n}/(\log\log n)^{2/3}$. If there is ever an overpowered cup, then the
% proposition is trivially satisfied, as backlog is $\Omega(\poly(n))$. Note that
% the filler doesn't need to know which cup is overpowered because it will take
% $\Omega(\poly(n))$ rounds for the emptier to reduce the fill below $\poly(n)$.
% Hence, we can assume without loss of generality that no cup is ever
% overpowered. Furthermore, if there is ever a cup with fill less than
% $-h\sqrt{n}/(\log\log n)^{2/3}$ then, in order to make the absolute fill of this cup
% non-negative, the absolute average fill of all the cups must be at least
% $h\sqrt{n}/(\log\log n)^{2/3}$. Hence there would exist an overpowered cup. Thus we
% have that without loss of generality all cups have fill bounded in magnitude by
% $h\sqrt{n}/(\log\log n)^{2/3}$.

% Now we detail how to achieve Step 1.
% We set apart a constant fraction $\alpha n= n/1000$ of the cups in $A$, which
% we call the \defn{storage-block}, or simply $C$. Let $\gamma = (\lg\lg
% n)^{1/3}$; we will store between
% $\gamma -\gamma/2$ and $\gamma + \gamma/2$ sets of $2\beta = \alpha n / (\gamma +
% \gamma/2)$ randomly chosen cups at certain randomly chosen rounds.
% For each anchor cup $c$ we will perform a procedure called a \defn{swapping-process}. 
% With probability $\frac{\gamma}{n/2}$ the swapping-processes consists of what
% we term a \defn{storing-operation}; in a storing-operation the filler takes a 
% random subset of $\beta$ cups from $B$, and a random subset of $\beta$ cups
% from $A \setminus C$, and swap these cups into the storage-block.
% Note that, by a Chernoff bound, the probability that the number of
% swapping-processes where we perform a storing-operation lies within $\pm
% \gamma/2$ of its expectation $\gamma$ is at least $1-2e^{-n(\gamma/2)^2}$,
% which is better than exponentially small in $n$, and in particular much
% better than the $1-1/\polylog n$ probability of success that we need.
% Thus we assume that the number of swapping-processes that consist of a
% storing-operation is between $\gamma- \gamma/2$ and $\gamma+\gamma/2$.

% On the other hand, with probability $1-\frac{\gamma}{n/2}$ the swapping-process
% does not entail performing a storing-operation; in this case the
% swapping-process is composed of a substructure, repeated many times, which we
% call a \defn{round-block}, which is a set of consecutive rounds. At the beginning of
% such a swapping-process we choose a round-block $j \in [n^2]$ uniformly at
% random from all the round-blocks. The swapping-process proceeds for $n^2$
% round-blocks; on the $j$-th round-block we swap a cup into the anchor set.

% For each round-block $i \in [n^2]$, the filler selects a random subset $D_i\subset
% B$ of the non-anchor cups and plays a single processor cup game on $D_i$. In this
% single-processor cup game the filler employs the classic adaptive strategy for
% achieving backlog $\Omega(\log |B|)$ on a set of $|B|$ cups, however modified
% because it is an oblivious filler. In particular, the filler's strategy in the
% single-processor cup games is to distribute water equally among an \defn{active
% set} of cups, and then after the emptier removes water from some cup the filler
% removes a random cup from the active set. There is at least constant
% probability that this results in the active set having a single cup at the end,
% with fill that has increased by at least $1/|B| + 1/(|B|-1) + \ldots + 1/1 \ge
% \ln |B|$ since the start of the round-block.

% On most round-blocks -- all but the $j$-th -- the filler does nothing with the
% cup that it achieves in the active set at the end of the single processor cup
% game. However, on the $j$-th round-block the filler swaps the winner of the
% single processor cup game into the anchor set.

% We consider two cases:
% \begin{itemize}
%   \item \textbf{Case 1:} For at least $1/2$ of the swapping-processes, at
%     least $1/2$ of the cups $c \in B$ have $\fil(c) \ge -384h$.
%   \item \textbf{Case 2:} For at least $1/2$ of the swapping-processes, less
%     than $1/2$ of the cups $c \in B$ have $\fil(c) \ge -384h$.
% \end{itemize}
% We now prove that in either case we can achieve high positive tilt in $A$ with
% good probability.

% \begin{clm} \label{clm:reg} 
%   Let $q\ge \Omega(1)$ be an appropriately small constant ($q$ is a function of
%   $h\le O(1)$). In Case 1, with probability at least $1-e^{-nq^2/1024}$, we
%   achieve fill at least $h$ in at least $nq/16$ of the cups in $A$ (i.e. a
%   constant fraction of the cups in $A$). 
% \end{clm}
% \begin{proof}
%   Consider a swapping-process where the filler does not perform a
%   storing-operation where at least $1/2$ of the cups $c \in B$ have $\fil(c)
%   \ge -96h$. Note that by assumption there are at least $n/4 - \gamma\cdot 3/2$ such rounds.
 
%   Say the emptier \defn{neglects} the anchor set in a round-block if on at
%   least one round of the round-block the emptier does not empty from every
%   anchor cup. By playing the single-processor cup game for $n^2$ round-blocks,
%   with only one round-block when we actually swap a cup into the anchor set, we
%   strongly disincentive the emptier from neglecting the anchor set on more
%   than a constant fraction of the round-blocks. 

%   The emptier must have some function $I(i): [n^2] \to \{0,1\}$ that indicates whether or
%   not they will neglect the anchor set on round-block $i$ if the filler has not
%   already swapped. Note that the emptier may know when the filler performs a
%   swap, so whether or not the emptier neglects a round-block $i$ depends on
%   this information. However, $j$ is the only parameter of the swapping-process,
%   so there is no other information that the emptier can use to decide whether
%   or not to neglect a round-block. Note that $I$ could be generated randomly,
%   but it still must exist. 

%   If the emptier is willing to neglect the anchor set for at least $1/2$ of the
%   round-blocks, i.e. $\sum_{i=1}^{n^2} I(i) \ge n^2 / 2$, then with probability
%   at least $1/4$, $j \in ((3/4) n^2, n^2)$, in which case the emptier neglects
%   the anchor set on at least $n^2/4$ round-blocks ($I(k)$ must be $1$ for at
%   least $n^2/4$ of the first $(3/4)n^2$ round-blocks). Each time the emptier
%   neglects the anchor set the mass of the anchor set increases by at least $1$.
%   Thus the average fill of the anchor set will have increased by at least
%   $(n^2/2)/(n/2) \ge \Omega(n)$ over the entire swapping-process in this
%   case, implying that we achieve an overpowered cup and satisfy the proposition. 

%   Otherwise, there is at least a $1/2$ chance that the round-block $j$, which
%   is chosen uniformly at random from the round-blocks, when the filler performs
%   a swap into the anchor set occurs on a round-block with $I(j)=0$, indicating
%   that the emptier won't neglect the anchor set on round-block $j$. In this
%   case, the round-block was a legitimate single processor cup game on $D_j$,
%   the randomly chosen set of $\lceil e^{385h} \rceil$ cups on the $j$-th round.
%   Then we achieve fill increase of at least $\ln \lceil e^{385h} \rceil \ge 385h$
%   by the end of the round-block with probability at least $1/\lceil
%   e^{385h}\rceil!$ -- the probability that we correctly guess the sequence of
%   cups within the single processor cup game that the emptier empties from. 

%   The probability that the random set $D_j \subset B$ contains only cups that
%   are among the $n/4$ fullest cups in $B$ is $${n/2 \choose {\lceil e^{97h}
%   \rceil}} / {n \choose {\lceil e^{385h}\rceil}} = O(1).$$ Note that because, by
%   assumption, at least half of the cups $c \in B$ have $\fil(c) \ge -384h$, then
%   the $n/4$ fullest cups in $B$ must have fill at least $-384h$. If all cups $
%   c\in D_j$ have $\fil(c) \ge -384h$, then the fill of the cup in the active set
%   at the end of the round-block is at least $-384h + 385h = h$, if the filler
%   guesses the emptier's emptying sequence correctly.

%   Say that a swapping-process where at least half of the cups $c\in B$ have
%   $\fil(c) \ge -384h$ \defn{succeeds} if $D_j$ is a subset of the $n/4$ fullest
%   cups in $B$, and if the filler correctly guesses the emptier's emptying
%   sequence. Note that if a swapping-process succeeds, then the filler is able
%   to swap a cup with fill at least $h$ into $A$. We have shown that there is a
%   constant probability of a given swapping-process succeeding. Let $X_i$ be the
%   binary random variable indicating whether or not the $i$-th swapping process
%   where the filler does not perform a storing-operation where at least half of
%   the cups $c\in B$ have $\fil(c) \ge -384h$ succeeds. Let $q \ge \Omega(1)$ be
%   the probability of a swapping-process succeeding, i.e. $P(X_i=1)$. Note that
%   the random variables $X_i$ are clearly independent, and identically
%   distributed.

%   Clearly $$\E\left[\sum_{i=1}^{n/8} X_i\right] = qn/8.$$ Note that we do not
%   use all the $X_i$; we know there must be at least $n/4 - 3/2 \gamma$
%   swapping-processes that do not consist of a storing-operation, but only use
%   $n/8$ of the $X_i$. We make this choice because the particular constants that
%   we get do not matter, and because it simplifies the analysis.
%   By a Chernoff Bound (i.e. Hoeffding's Inequality applied to binary random variables),
%   $$P\left(\sum_{i=1}^{n/8} X_i\le nq/16\right) \le e^{-nq^2/1024}.$$ That is, the
%   probability that less than $nq/16$ of the anchor cups have fill at least $h$ is
%   exponentially small in $n$, as desired.

% \end{proof}

% \begin{clm}
%   \label{clm:xtreme}
%   In Case 2, with probability at least $1- 1/\polylog(n)$, we achieve positive
%   tilt $n \alpha \cdot h$ in the anchor set.
% \end{clm}

% \begin{proof}
%   Consider a swapping-process on which the filler does a storing-operation and
%   at least half of the cups $c \in B$ have $\fil(c) < -384h$. Then there is a
%   set of cups with no more than $-384h \cdot n/4 = -nh\cdot 96$.

%   If the storage-block $C$ already has positive tilt at least $nh\cdot 48 \ge
%   n\alpha \cdot h$ then the filler has already succeeded, as no water ever
%   exits the storage-block.

%   Otherwise, at least one of $A$ or $B$ must have large positive tilt in order
%   to offset the many cups in $B$ with fill less than $-96h$. In particular, the
%   positive tilt of $A \cup B \setminus C$ must be at least $nh\cdot 96 - nh\cdot 48 =
%   nh\cdot 48$. Let $D=B$ if $\tilt(B) > \tilt(A)$ and $D=A$ otherwise. Note that
%   $\tilt(D) \ge nh\cdot 24$. Because there are no overpowered cups, this positive
%   tilt is distributed among many cups. Note that if $X$ is a cup chosen
%   uniformly randomly from $D$ then $$\E[\tilt(X)] \ge h\cdot 48.$$ Let
%   $Y_1,Y_2,\ldots, Y_\beta$ be the positive tilts of a set of $\beta$ cups
%   drawn from $D$, with all subsets equally likely; equivalently, consider
%   $Y_1,\ldots, Y_\beta$ to be the positive tilts of $\beta$ cups sampled from
%   $D$, sampling without replacement. Recall that $\beta =
%   \frac{1}{2}\frac{\alpha n}{\gamma\cdot 3/2}$, $\gamma = (\lg \lg n)^{1/3}$.
%   We apply Hoeffding's Inequality for samples drawn with replacement (stated in
%   Corollary \ref{cor:hoeffdingwreplacement}) to $\sum_{i=1}^\beta Y_i$. Note
%   that $0\le Y_i \le h\sqrt{n}/(\log\log n)^{2/3}$, as positive tilt is
%   non-negative, and as there are no overpowered cups. 
%   Thus we have, 
%   \begin{align*}
%   P\left(\frac{1}{\beta} \sum_{i=1}^{\beta} (Y_i - \E[Y_i]) \le -h\cdot 24 \right) \le\\
%   \exp\left(-\frac{2\beta(h\cdot 24)^2}{(h\sqrt{n}/(\log\log n)^{2/3})^2}\right).
%   \end{align*}
%   Simplifying this gives,
%   $$P\left(\frac{1}{\beta}\sum_{i=1}^{\beta} Y_i \le h\cdot 24\right) \le \frac{1}{\polylog(n)}.$$

%   Now we will show that with probability at least $1-1/\polylog(n)$ there are
%   at least $\gamma/4$ swapping-processes on which the filler does a
%   storing-operation.
%   Recall that at least $\gamma/2$ storing-operations happen. Choose a random
%   set of $\gamma/2$ of the storing-operations that happen. Note that the
%   distribution of these sets will clearly be identical to the distribution we
%   would get if we simply selected a random subset of $\gamma/2$ of the
%   swapping-process, or equivalently, if we had sampled $\gamma/2$ of the
%   swapping-processes sampling without replacement. Let $Z_i$ be the indicator
%   random variable for whether or not the $i$-th of these swapping-processes occurs on a round
%   where at least half of the cups $c \in B$ have $\fil(c) < -384h$.
%   Clearly $\E\left[\sum_{i=1}^{\gamma/2} Z_i\right] \ge \gamma/4.$ 
%   Then a Chernoff bound gives that
%   $$P\left(\sum_{i=1}^{\gamma/2} Z_i \ge \gamma/8 \right) \ge 1-e^{-2(\gamma/2) (\gamma/8)^2},$$
%   and recalling that $\gamma=(\lg\lg n)^{1/3}$ this simplifies to 
%   $$P\left(\sum_{i=1}^{\gamma/2} Z_i \ge \gamma/8 \right) \ge 1-\frac{1}{\polylog(n)}.$$

%   Combining these, with probability at least
%   $$\left(1-\frac{1}{\polylog(n)}\right)\left(1-\frac{1}{\polylog(n)}\right) =
%   1-\frac{1}{\polylog(n)}$$ we achieve positive
%   tilt at least $\beta h\cdot 24$ in at least $\gamma/8$ sets of $\beta$ cups. In
%   total, this means that means we have positive tilt $(\beta h \cdot 24)(\gamma/8) =
%   \frac{\alpha n/2}{(3/2)\gamma}\gamma h \cdot{24}{8} = n\alpha h$ in the anchor set, as desired.

% \end{proof}

%   By Claim \ref{clm:reg} in Case 1 the filler achieves, with probability at least
%   $1-1/\polylog n$ (in fact with much better probability) fill at least $h$ in
%   some constant fraction $nc$ of the cups.

%   In Case 2 by Claim \ref{clm:xtreme} the filler achieves, with probability at least
%   $1-1/\polylog n$, positive tilt at least $nh\alaph$ in the storage-block,
%   which consists of $\alpha n$ cups. Then 
%   $$\sum_{x\in C} \lfloor \tilt(x) / (h/2) \rfloor \ge \sum_{x\in C} (\tilt(x) / (h/2) -1) = n\alpha.$$

%   Using the cups that have fill chunks of $h$, setting the number of processors to $1$, and
%   exploiting the greedy nature of the emptier, the filler can obtain high fill
%   in a set of $nc$ \emph{known} cups.

%   In particular, the filler chooses a set of $nc$ cups randomly.
%   With probability at least $1/2$ the average fill of $nc$ is positive by a
%   Hoeffding bound and the fact that 
%   OH CRAP THIS JUST BROKE. YOU COULD SMOOTH IT. BUT THATS NOT FUN.
%   The filler repeatedly distributes a unit of water equally among these $nc$ cups. 
%   The filler continues until the average fill of that set of cups has increased
%   by $h'$. The filler uses one processor because it doesn't know how many cups
%   the positive tilt is concentrated in. Then the filler recurses on the set of
%   $nc$ known cups with average fill.

%   Note that this transformation from a set with high positive tilt to a set of
%   known cups with high positive average fill is the only part of the proof of
%   Proposition \ref{prop:obliviousBase} that is specific to a greedy-like
%   emptier. Against a general emptier it is not true that the emptier will
%   necessarily focus on the set of cups with high positive tilt; an arbitrary
%   emptier can of course foil our attempts to achieve high fill in any fixed set
%   of $p$ cups, at a given setting of $p$. Extending Proposition
%   \ref{prop:obliviousBase} to apply to non-greedy-like emptiers is an important
%   open question.
% \end{proof}

\section{Conclusion}
Many important open questions remain open. Can our oblivious cup game results
be improved, e.g. by expanding them to apply to a broader class of emptiers?
Can the classic oblivious multi-processor cup-game be tightly analyzed?
These are interesting questions.

\bibliographystyle{plain}
\bibliography{paper}
\end{document}
